<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ü§ñ OpenAI API Test for ManageLandingPage</h1>
    
    <div class="test-section info">
        <h3>üìã Test Instructions</h3>
        <p>This test will verify if your AI analysis functionality is working correctly.</p>
        <ol>
            <li>Test basic API connectivity</li>
            <li>Test sentiment analysis with different testimonials</li>
            <li>Verify JSON parsing works correctly</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h3>üîë API Key Status</h3>
        <p id="api-status">‚úÖ API Key configured</p>
    </div>
    
    <div class="test-section">
        <h3>üåê Connectivity Test</h3>
        <button id="test-connection" onclick="testConnection()">Test OpenAI Connection</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h3>üéØ Sentiment Analysis Test</h3>
        <textarea id="feedback-input" placeholder="Enter testimonial feedback to analyze...">This app is amazing! I love the personalized workouts and nutrition tracking. It has really helped me achieve my fitness goals. Highly recommended!</textarea>
        <br>
        <label>Star Rating: 
            <select id="rating-input">
                <option value="5">5 stars</option>
                <option value="4">4 stars</option>
                <option value="3">3 stars</option>
                <option value="2">2 stars</option>
                <option value="1">1 star</option>
            </select>
        </label>
        <br>
        <button id="test-sentiment" onclick="testSentimentAnalysis()">Analyze Sentiment</button>
        <div id="sentiment-result"></div>
    </div>
    
    <div class="test-section">
        <h3>‚ö° Batch Test</h3>
        <button id="test-batch" onclick="testBatchAnalysis()">Test Multiple Testimonials</button>
        <div id="batch-result"></div>
    </div>

    <script>
        // Your OpenAI API configuration
        const OPENAI_API_KEY = localStorage.getItem('openai_api_key') || prompt('Enter your OpenAI API key:') || 'your-openai-api-key-here';
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        
        async function testConnection() {
            const button = document.getElementById('test-connection');
            const resultDiv = document.getElementById('connection-result');
            
            button.disabled = true;
            button.textContent = 'Testing...';
            resultDiv.innerHTML = '<p>Testing OpenAI API connection...</p>';
            
            try {
                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: 'Say "Hello, API is working!"'
                        }],
                        max_tokens: 20
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Connection Successful!</h4>
                            <p><strong>Response:</strong> ${data.choices[0].message.content}</p>
                            <p><strong>Model:</strong> ${data.model}</p>
                            <p><strong>Usage:</strong> ${data.usage.total_tokens} tokens</p>
                        </div>
                    `;
                } else {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Connection Failed (${response.status})</h4>
                            <pre>${errorData}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Network Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.textContent = 'Test OpenAI Connection';
            }
        }
        
        async function testSentimentAnalysis() {
            const button = document.getElementById('test-sentiment');
            const resultDiv = document.getElementById('sentiment-result');
            const feedback = document.getElementById('feedback-input').value;
            const rating = document.getElementById('rating-input').value;
            
            if (!feedback.trim()) {
                resultDiv.innerHTML = '<div class="error">Please enter some feedback to analyze</div>';
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Analyzing...';
            resultDiv.innerHTML = '<p>Analyzing sentiment...</p>';
            
            try {
                const analysis = await callOpenAI(feedback, parseInt(rating));
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Analysis Complete!</h4>
                        <p><strong>Feedback:</strong> "${feedback}"</p>
                        <p><strong>Rating:</strong> ${rating} stars</p>
                        <p><strong>Sentiment:</strong> ${analysis.sentiment}</p>
                        <p><strong>Confidence:</strong> ${Math.round(analysis.confidence * 100)}%</p>
                        <p><strong>Flags:</strong> ${analysis.flags && analysis.flags.length > 0 ? analysis.flags.join(', ') : 'None'}</p>
                        <details>
                            <summary>Raw Response</summary>
                            <pre>${JSON.stringify(analysis, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Analysis Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.textContent = 'Analyze Sentiment';
            }
        }
        
        async function testBatchAnalysis() {
            const button = document.getElementById('test-batch');
            const resultDiv = document.getElementById('batch-result');
            
            const testCases = [
                { feedback: "Amazing app! Love the workouts and nutrition plans!", rating: 5 },
                { feedback: "Good app but could use some improvements in the UI", rating: 3 },
                { feedback: "Terrible experience, app crashes constantly", rating: 1 },
                { feedback: "Best fitness app ever! Highly recommend!", rating: 5 },
                { feedback: "It's okay, nothing special", rating: 3 }
            ];
            
            button.disabled = true;
            button.textContent = 'Testing...';
            resultDiv.innerHTML = '<p>Running batch analysis...</p>';
            
            try {
                const results = [];
                
                for (let i = 0; i < testCases.length; i++) {
                    const testCase = testCases[i];
                    button.textContent = `Analyzing ${i + 1}/${testCases.length}...`;
                    
                    const analysis = await callOpenAI(testCase.feedback, testCase.rating);
                    results.push({ ...testCase, analysis });
                    
                    // Small delay to avoid rate limiting
                    if (i < testCases.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                let html = '<div class="success"><h4>‚úÖ Batch Analysis Complete!</h4><table border="1" style="width:100%; border-collapse: collapse;">';
                html += '<tr><th>Feedback</th><th>Rating</th><th>Sentiment</th><th>Confidence</th><th>Flags</th></tr>';
                
                results.forEach(result => {
                    html += `<tr>
                        <td style="padding: 5px;">${result.feedback}</td>
                        <td style="padding: 5px;">${result.rating}‚òÖ</td>
                        <td style="padding: 5px;">${result.analysis.sentiment}</td>
                        <td style="padding: 5px;">${Math.round(result.analysis.confidence * 100)}%</td>
                        <td style="padding: 5px;">${result.analysis.flags ? result.analysis.flags.join(', ') : 'None'}</td>
                    </tr>`;
                });
                
                html += '</table></div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Batch Analysis Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.textContent = 'Test Multiple Testimonials';
            }
        }
        
        // Copy the callOpenAI function from your ManageLandingPage.html
        async function callOpenAI(feedback, starRating = null) {
            const ratingContext = starRating ? `\\nStar Rating: ${starRating}/5 stars` : '';
            
            const prompt = `Analyze the following customer testimonial and provide:
1. Sentiment: positive, negative, neutral, spam, or inappropriate
2. Confidence score (0-1)
3. Any flags for concerns (spam, inappropriate language, fake review, rating-text mismatch, etc.)

Testimonial: "${feedback}"${ratingContext}

Guidelines:
- 5 stars usually indicates positive sentiment
- 4 stars usually indicates positive sentiment
- 3 stars and below usually indicates negative or neutral sentiment
- Flag if star rating doesn't match the text sentiment
- Consider both text content and star rating for final sentiment

Respond in JSON format:
{
  "sentiment": "positive|negative|neutral|spam|inappropriate",
  "confidence": 0.95,
  "flags": ["spam", "inappropriate", "rating_text_mismatch"]
}`;
            
            try {
                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert at analyzing customer feedback sentiment and detecting spam or inappropriate content. Always respond with valid JSON.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.1
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}. Details: ${errorText}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content.trim();
                
                try {
                    return JSON.parse(aiResponse);
                } catch (parseError) {
                    console.error('Error parsing AI response:', aiResponse);
                    
                    // Fallback parsing
                    return {
                        sentiment: 'neutral',
                        confidence: 0.5,
                        flags: ['parsing_error']
                    };
                }
                
            } catch (networkError) {
                throw new Error(`Failed to call OpenAI API: ${networkError.message}`);
            }
        }
    </script>
</body>
</html>
