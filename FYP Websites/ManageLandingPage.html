<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Landing Page - Wise Fitness</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-hover: #0056b3;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light-bg: #f9f9f9;
      --card-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.12);
      --radius: 14px;
      --text-light: #222;
      --text-muted: #6c757d;
      --border-color: #e9ecef;
      --transition: 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      transition: padding-right var(--transition);
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 260px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: -2px 0 12px rgba(0, 0, 0, 0.1);
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border-radius: 14px 0 0 14px;
      transform: translateX(100%);
      transition: transform var(--transition);
      z-index: 30;
      overflow-y: auto;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar button {
      background: var(--light-bg);
      border: none;
      border-radius: var(--radius);
      padding: 14px 22px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      color: var(--text-light);
      text-align: left;
      transition: background-color var(--transition), color var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar button:hover {
      background: var(--primary);
      color: white;
    }

    /* HEADER */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: var(--shadow);
      z-index: 100;
      border-radius: 0 0 var(--radius) var(--radius);
      transition: right var(--transition), width var(--transition);
    }

    body.sidebar-active .header {
      right: 260px;
      width: calc(100% - 260px);
    }

    #backBtn,
    #menuBtn {
      background: transparent;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .headerTitle {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      flex-grow: 1;
      margin: 0 12px;
    }

    /* MAIN CONTAINER */
    .container {
      max-width: 1000px;
      margin: 80px auto 40px;
      padding: 24px 20px;
      transition: padding-right var(--transition);
      overflow-y: auto;
    }

    body.sidebar-active .container {
      padding-right: 280px;
    }

    /* SECTION CARDS */
    .section-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      padding: 1.5rem 2rem;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .section-header:hover {
      background: linear-gradient(135deg, var(--primary-hover) 0%, #003d82 100%);
    }

    .section-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .section-content.active {
      padding: 2rem;
      max-height: 2000px;
    }

    .toggle-icon {
      transition: transform var(--transition);
      font-size: 1.2rem;
    }

    .section-card.active .toggle-icon {
      transform: rotate(180deg);
    }

    /* FORM ELEMENTS */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    input[type="text"], 
    input[type="url"],
    textarea, 
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      transition: var(--transition);
      background: #fff;
      font-family: inherit;
    }

    input:focus, 
    textarea:focus, 
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* FILE UPLOAD */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(0, 123, 255, 0.05);
    }

    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(0, 123, 255, 0.1);
    }

    .file-input {
      display: none;
    }

    .upload-text {
      margin-top: 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* IMAGE GALLERY */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      aspect-ratio: 1;
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* SERVICE ITEM */
    .service-item-editor {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      background: #fafafa;
    }

    .service-item-header {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }

    /* BUTTONS */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      text-align: center;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-block {
      width: 100%;
      margin-top: 1rem;
    }

    /* PROGRESS BAR */
    .progress {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* MESSAGES */
    .message {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 600;
      text-align: center;
    }

    .message.success {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .message.error {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        margin: 70px 10px 20px;
        padding: 16px;
      }

      body.sidebar-active .container {
        padding-right: 16px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .section-content.active {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button onclick="window.open('index.html', '_blank')" style="background: #28a745; margin-bottom: 20px;">üîç Preview Landing Page</button>
    <button onclick="goProfile()">Profile</button>
    <button onclick="goSettings()">Settings</button>
    <button onclick="logout()">Logout</button>
    <button onclick="resetPassword()">Reset Password</button>
  </div>

  <!-- Header -->
  <header class="header">
    <button id="backBtn" title="Back">‚Üê</button>
    <div class="headerTitle">Manage Landing Page</div>
    <button id="menuBtn" title="Menu">‚ò∞</button>
  </header>

  <!-- Main Form -->
  <main class="container">
    <div id="globalMessage" class="message" style="display: none;"></div>

    <!-- About Us Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('about')">
        <span>üìù About Us Section</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="about-content">
        <form id="aboutForm">
          <div class="form-group">
            <label for="aboutTitle">Section Title</label>
            <input type="text" id="aboutTitle" placeholder="e.g., Welcome to Wise Fitness">
          </div>

          <div class="form-group">
            <label for="aboutSubtitle">Section Subtitle</label>
            <textarea id="aboutSubtitle" rows="2" placeholder="Brief description..."></textarea>
          </div>

          <div class="form-group">
            <label for="aboutMessage">Main Message</label>
            <textarea id="aboutMessage" rows="4" placeholder="Detailed about us content..."></textarea>
          </div>

          <div class="form-group">
            <label>Image Gallery (Optional)</label>
            <div class="upload-area" onclick="document.getElementById('aboutImages').click()">
              <div style="font-size: 2rem;">üì∑</div>
              <div class="upload-text">Click to upload images or drag and drop</div>
              <input type="file" id="aboutImages" class="file-input" multiple accept="image/*">
            </div>
            <div class="progress" id="aboutProgress" style="display: none;">
              <div class="progress-bar" id="aboutProgressBar"></div>
            </div>
            <div class="image-gallery" id="aboutGallery"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">üíæ Save About Us</button>
        </form>
      </div>
    </div>

    <!-- Services Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('services')">
        <span>üõ†Ô∏è Our Services Section</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="services-content">
        <form id="servicesForm">
          <div class="form-group">
            <label for="servicesTitle">Section Title</label>
            <input type="text" id="servicesTitle" placeholder="e.g., Our Services">
          </div>

          <div class="form-group">
            <label for="servicesSubtitle">Section Subtitle</label>
            <textarea id="servicesSubtitle" rows="2" placeholder="Services description..."></textarea>
          </div>

          <!-- Service Item 1 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 1</div>
            <div class="form-row">
              <div>
                <label for="service1Title">Title</label>
                <input type="text" id="service1Title" placeholder="Service title">
              </div>
              <div>
                <label for="service1Icon">Icon/Emoji</label>
                <input type="text" id="service1Icon" placeholder="üí™">
              </div>
            </div>
            <div class="form-group">
              <label for="service1Desc">Description</label>
              <textarea id="service1Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service1Image">Image URL (Optional)</label>
              <input type="url" id="service1Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <!-- Service Item 2 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 2</div>
            <div class="form-row">
              <div>
                <label for="service2Title">Title</label>
                <input type="text" id="service2Title" placeholder="Service title">
              </div>
              <div>
                <label for="service2Icon">Icon/Emoji</label>
                <input type="text" id="service2Icon" placeholder="üë•">
              </div>
            </div>
            <div class="form-group">
              <label for="service2Desc">Description</label>
              <textarea id="service2Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service2Image">Image URL (Optional)</label>
              <input type="url" id="service2Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <!-- Service Item 3 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 3</div>
            <div class="form-row">
              <div>
                <label for="service3Title">Title</label>
                <input type="text" id="service3Title" placeholder="Service title">
              </div>
              <div>
                <label for="service3Icon">Icon/Emoji</label>
                <input type="text" id="service3Icon" placeholder="ü•ó">
              </div>
            </div>
            <div class="form-group">
              <label for="service3Desc">Description</label>
              <textarea id="service3Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service3Image">Image URL (Optional)</label>
              <input type="url" id="service3Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">üõ†Ô∏è Save Services</button>
        </form>
      </div>
    </div>

    <!-- Testimonials Management Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('testimonials')">
        <span>üí¨ Testimonials Management</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="testimonials-content">
        
        <!-- AI Filter Settings -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem;">ü§ñ AI Content Filtering</h4>
          <div class="form-row">
            <div>
              <label for="filterSensitivity">Filter Sensitivity</label>
              <select id="filterSensitivity">
                <option value="low">Low - Basic spam detection</option>
                <option value="medium" selected>Medium - Recommended</option>
                <option value="high">High - Strict filtering</option>
              </select>
            </div>
            <div>
              <label for="minRating">Minimum Rating</label>
              <select id="minRating">
                <option value="3">3 Stars and above</option>
                <option value="4" selected>4 Stars and above</option>
                <option value="5">5 Stars only</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="enableAIFilter" checked> 
              Enable AI-powered content filtering
            </label>
            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
              Automatically filters out spam, inappropriate content, and inconsistent reviews
            </small>
          </div>
          
          <button class="btn btn-primary" onclick="updateFilterSettings()">üíæ Save Filter Settings</button>
        </div>

        <!-- Testimonials Dashboard -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0; color: #28a745;" id="approvedCount">0</h3>
            <small>Approved Reviews</small>
          </div>
          <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0; color: #ffc107;" id="pendingCount">0</h3>
            <small>Pending Review</small>
          </div>
          <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0; color: #dc3545;" id="rejectedCount">0</h3>
            <small>Auto-Rejected</small>
          </div>
          <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0; color: #007bff;" id="totalCount">0</h3>
            <small>Total Submitted</small>
          </div>
        </div>

        <!-- Testimonials List -->
        <div style="margin-bottom: 1rem;">
          <h4 style="color: var(--primary);">üìã Review Management</h4>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button class="btn btn-secondary" onclick="loadTestimonials('pending')">Pending (0)</button>
            <button class="btn btn-secondary" onclick="loadTestimonials('approved')">Approved (0)</button>
            <button class="btn btn-secondary" onclick="loadTestimonials('rejected')">Rejected (0)</button>
            <button class="btn btn-primary" onclick="loadTestimonials('all')">All Reviews</button>
          </div>
        </div>

        <div id="testimonialsList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
          <p style="text-align: center; color: var(--text-muted);">Click "All Reviews" to load testimonials</p>
        </div>

        <!-- Bulk Actions -->
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
          <h4 style="color: var(--primary);">‚ö° Bulk Actions</h4>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="bulkApproveHighRated()">‚úÖ Approve All 5-Star Reviews</button>
            <button class="btn btn-secondary" onclick="runAIAnalysis()">ü§ñ Run AI Analysis on Pending</button>
            <button class="btn btn-secondary" onclick="exportTestimonials()">üì• Export All Reviews</button>
            <button class="btn btn-secondary" onclick="generateInsights()">üìä Generate Insights</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('actions')">
        <span>‚ö° Quick Actions & Template Management</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="actions-content">
        <div style="margin-bottom: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">üîÑ Template Management</h4>
          <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
            The reset function will restore all content to the original Wise Fitness template. This includes restoring default text, removing custom images, and resetting all service configurations. The testimonials section will not be affected as it's dynamically loaded from user reviews.
          </p>
          <button class="btn btn-secondary" onclick="resetToDefaults()" style="background: #dc3545; border: none; margin-bottom: 1rem; width: 100%;">
            üîÑ Reset to Default Template
          </button>
        </div>
        
        <div style="border-top: 1px solid var(--border-color); padding-top: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">üîß Admin Tools</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-secondary" onclick="previewLandingPage()">üëÅÔ∏è Preview Landing Page</button>
            <button class="btn btn-secondary" onclick="exportBackup()">üì• Export Content Backup</button>
            <button class="btn btn-secondary" onclick="validateContent()">‚úÖ Validate All Content</button>
            <button class="btn btn-secondary" onclick="viewAnalytics()">üìä View Content Analytics</button>
          </div>
        </div>
        
        <div style="border-top: 1px solid var(--border-color); padding-top: 2rem; margin-top: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">‚ÑπÔ∏è Template Information</h4>
          <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: var(--text-muted);">
            <p><strong>Current Template:</strong> Wise Fitness Default v1.0</p>
            <p><strong>Last Modified:</strong> <span id="lastModified">Loading...</span></p>
            <p><strong>Sections Managed:</strong> About Us, Services (Testimonials are dynamic)</p>
            <p><strong>Image Storage:</strong> Firebase Storage with automatic cleanup</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Import additional Firestore functions for testimonials
    import { 
      collection, 
      query, 
      where, 
      orderBy, 
      getDocs, 
      addDoc, 
      updateDoc, 
      deleteDoc,
      writeBatch 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIFV7ynXUzA0p-CrmVOE2lFRgaf_9g_k4",
      authDomain: "fyp-25-s2-09.firebaseapp.com",
      projectId: "fyp-25-s2-09",
      storageBucket: "fyp-25-s2-09.appspot.com",
      messagingSenderId: "838641447649",
      appId: "1:838641447649:web:6ddfb234b3d445f16dbda0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const globalMessage = document.getElementById("globalMessage");
    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menuBtn");

    // Global variables for uploaded images
    let aboutImages = [];

    // Back button
    document.getElementById("backBtn").addEventListener("click", () => {
      history.back();
    });

    // Toggle sidebar
    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("active");
      document.body.classList.toggle("sidebar-active");
    });

    // Toggle sections
    window.toggleSection = (sectionId) => {
      const content = document.getElementById(sectionId + '-content');
      const card = content.closest('.section-card');
      
      if (content.classList.contains('active')) {
        content.classList.remove('active');
        card.classList.remove('active');
      } else {
        // Close all other sections
        document.querySelectorAll('.section-content').forEach(el => {
          el.classList.remove('active');
          el.closest('.section-card').classList.remove('active');
        });
        
        content.classList.add('active');
        card.classList.add('active');
      }
    };

    // Show message function
    function showMessage(message, type = 'success') {
      globalMessage.textContent = message;
      globalMessage.className = `message ${type}`;
      globalMessage.style.display = 'block';
      
      setTimeout(() => {
        globalMessage.style.display = 'none';
      }, 5000);
    }

    // File upload handlers
    document.getElementById('aboutImages').addEventListener('change', handleAboutImageUpload);

    async function handleAboutImageUpload(event) {
      const files = Array.from(event.target.files);
      const progressBar = document.getElementById('aboutProgressBar');
      const progress = document.getElementById('aboutProgress');
      
      if (files.length === 0) return;
      
      progress.style.display = 'block';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        try {
          // Create unique filename
          const timestamp = Date.now();
          const filename = `about_${timestamp}_${i}_${file.name}`;
          const storageRef = ref(storage, `landing-page/about/${filename}`);
          
          // Upload file
          const snapshot = await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          
          // Add to images array
          aboutImages.push({
            url: downloadURL,
            filename: filename,
            ref: storageRef
          });
          
          // Update progress
          const progressPercent = ((i + 1) / files.length) * 100;
          progressBar.style.width = progressPercent + '%';
          
          // Add to gallery
          addImageToGallery(downloadURL, filename, 'about');
          
        } catch (error) {
          console.error('Error uploading image:', error);
          showMessage(`Error uploading ${file.name}: ${error.message}`, 'error');
        }
      }
      
      progress.style.display = 'none';
      progressBar.style.width = '0%';
      
      showMessage(`Successfully uploaded ${files.length} image(s)`, 'success');
    }

    function addImageToGallery(url, filename, galleryType) {
      const gallery = document.getElementById(galleryType + 'Gallery');
      
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      imageItem.innerHTML = `
        <img src="${url}" alt="Gallery image" loading="lazy">
        <button class="remove-image" onclick="removeImage('${filename}', '${galleryType}', this)">√ó</button>
      `;
      
      gallery.appendChild(imageItem);
    }

    window.removeImage = async (filename, galleryType, button) => {
      try {
        // Remove from storage
        const imageRef = ref(storage, `landing-page/${galleryType}/${filename}`);
        await deleteObject(imageRef);
        
        // Remove from local array
        if (galleryType === 'about') {
          aboutImages = aboutImages.filter(img => img.filename !== filename);
        }
        
        // Remove from DOM
        button.closest('.image-item').remove();
        
        showMessage('Image removed successfully', 'success');
      } catch (error) {
        console.error('Error removing image:', error);
        showMessage('Error removing image: ' + error.message, 'error');
      }
    };

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("You must be logged in.");
        window.location.href = "Login.html";
        return;
      }

      const adminDocRef = doc(db, "admins", user.uid);
      const adminDoc = await getDoc(adminDocRef);

      if (!adminDoc.exists()) {
        alert("Access denied. You are not a system admin.");
        await signOut(auth);
        window.location.href = "Login.html";
        return;
      }

      await loadAllContent();
      await loadAISettings();
    });

    async function loadAllContent() {
      try {
        await loadAboutSection();
        await loadServicesSection();
        await updateLastModifiedInfo();
      } catch (error) {
        console.error('Error loading content:', error);
        showMessage('Error loading content: ' + error.message, 'error');
      }
    }

    async function updateLastModifiedInfo() {
      try {
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let lastModified = null;
        
        if (aboutDoc.exists() && aboutDoc.data().lastUpdated) {
          const aboutDate = aboutDoc.data().lastUpdated.toDate();
          if (!lastModified || aboutDate > lastModified) {
            lastModified = aboutDate;
          }
        }
        
        if (servicesDoc.exists() && servicesDoc.data().lastUpdated) {
          const servicesDate = servicesDoc.data().lastUpdated.toDate();
          if (!lastModified || servicesDate > lastModified) {
            lastModified = servicesDate;
          }
        }
        
        const lastModifiedElement = document.getElementById('lastModified');
        if (lastModifiedElement) {
          if (lastModified) {
            lastModifiedElement.textContent = lastModified.toLocaleString();
          } else {
            lastModifiedElement.textContent = 'Never modified (using defaults)';
          }
        }
      } catch (error) {
        console.error('Error updating last modified info:', error);
      }
    }

    async function loadAboutSection() {
      const docRef = doc(db, "landingPage", "about");
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('aboutTitle').value = data.title || "";
        document.getElementById('aboutSubtitle').value = data.subtitle || "";
        document.getElementById('aboutMessage').value = data.message || "";
        
        // Load images
        if (data.images && data.images.length > 0) {
          aboutImages = data.images;
          const gallery = document.getElementById('aboutGallery');
          gallery.innerHTML = '';
          
          data.images.forEach(img => {
            addImageToGallery(img.url, img.filename, 'about');
          });
        }
      } else {
        // Load from existing main document for backward compatibility
        const mainDocRef = doc(db, "landingPage", "main");
        const mainDocSnap = await getDoc(mainDocRef);
        
        if (mainDocSnap.exists()) {
          const data = mainDocSnap.data();
          document.getElementById('aboutTitle').value = data.welcomeText || "";
          document.getElementById('aboutSubtitle').value = data.slogan || "";
          document.getElementById('aboutMessage').value = data.aboutSection || "";
        }
      }
    }

    async function loadServicesSection() {
      const docRef = doc(db, "landingPage", "services");
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('servicesTitle').value = data.title || "";
        document.getElementById('servicesSubtitle').value = data.subtitle || "";
        
        // Load individual services
        if (data.services) {
          data.services.forEach((service, index) => {
            const serviceNum = index + 1;
            document.getElementById(`service${serviceNum}Title`).value = service.title || "";
            document.getElementById(`service${serviceNum}Icon`).value = service.icon || "";
            document.getElementById(`service${serviceNum}Desc`).value = service.description || "";
            document.getElementById(`service${serviceNum}Image`).value = service.imageUrl || "";
          });
        }
      } else {
        // Set default values
        document.getElementById('servicesTitle').value = "Our Services";
        document.getElementById('servicesSubtitle').value = "Comprehensive fitness solutions tailored to your needs";
        
        // Default services
        const defaultServices = [
          { title: "üí™ Personal Training", icon: "üí™", description: "One-on-one training sessions tailored to your specific needs and goals.", imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=200&h=200&fit=crop&crop=face" },
          { title: "üë• Group Fitness Classes", icon: "üë•", description: "Fun and motivating group workouts for all fitness levels.", imageUrl: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=200&h=200&fit=crop&crop=face" },
          { title: "ü•ó Nutrition Coaching", icon: "ü•ó", description: "Personalized nutrition plans to support your fitness journey.", imageUrl: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=200&h=200&fit=crop&crop=center" }
        ];
        
        defaultServices.forEach((service, index) => {
          const serviceNum = index + 1;
          document.getElementById(`service${serviceNum}Title`).value = service.title;
          document.getElementById(`service${serviceNum}Icon`).value = service.icon;
          document.getElementById(`service${serviceNum}Desc`).value = service.description;
          document.getElementById(`service${serviceNum}Image`).value = service.imageUrl;
        });
      }
    }

    // Form submissions
    document.getElementById('aboutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const aboutData = {
          title: document.getElementById('aboutTitle').value.trim(),
          subtitle: document.getElementById('aboutSubtitle').value.trim(),
          message: document.getElementById('aboutMessage').value.trim(),
          images: aboutImages,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        };
        
        await setDoc(doc(db, "landingPage", "about"), aboutData);
        
        // Also update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          welcomeText: aboutData.title,
          slogan: aboutData.subtitle,
          aboutSection: aboutData.message,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        }, { merge: true });
        
        await updateLastModifiedInfo();
        showMessage('‚úÖ About Us section saved successfully!', 'success');
        
        // Add preview link
        setTimeout(() => {
          const previewMsg = document.createElement('div');
          previewMsg.innerHTML = '<a href="index.html" target="_blank" style="color: #007bff; text-decoration: underline;">üîó Click here to preview your changes</a>';
          globalMessage.appendChild(previewMsg);
        }, 1000);
      } catch (error) {
        console.error('Error saving about section:', error);
        showMessage('‚ùå Error saving About Us: ' + error.message, 'error');
      }
    });

    document.getElementById('servicesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const services = [];
        for (let i = 1; i <= 3; i++) {
          services.push({
            title: document.getElementById(`service${i}Title`).value.trim(),
            icon: document.getElementById(`service${i}Icon`).value.trim(),
            description: document.getElementById(`service${i}Desc`).value.trim(),
            imageUrl: document.getElementById(`service${i}Image`).value.trim()
          });
        }
        
        const servicesData = {
          title: document.getElementById('servicesTitle').value.trim(),
          subtitle: document.getElementById('servicesSubtitle').value.trim(),
          services: services,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        };
        
        await setDoc(doc(db, "landingPage", "services"), servicesData);
        
        // Also update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          services: services,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        }, { merge: true });
        
        await updateLastModifiedInfo();
        showMessage('‚úÖ Services section saved successfully!', 'success');
        
        // Add preview link
        setTimeout(() => {
          const previewMsg = document.createElement('div');
          previewMsg.innerHTML = '<a href="index.html" target="_blank" style="color: #007bff; text-decoration: underline;">üîó Click here to preview your changes</a>';
          globalMessage.appendChild(previewMsg);
        }, 1000);
      } catch (error) {
        console.error('Error saving services:', error);
        showMessage('‚ùå Error saving Services: ' + error.message, 'error');
      }
    });

    // Quick actions
    window.previewLandingPage = () => {
      window.open('index.html', '_blank');
    };

    window.exportBackup = async () => {
      try {
        showMessage('Preparing backup...', 'success');
        
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        const mainDoc = await getDoc(doc(db, "landingPage", "main"));
        
        const backup = {
          exportInfo: {
            templateName: "Wise Fitness Landing Page",
            exportDate: new Date().toISOString(),
            version: "1.0",
            adminNote: "Backup created from admin interface"
          },
          content: {
            about: aboutDoc.exists() ? aboutDoc.data() : null,
            services: servicesDoc.exists() ? servicesDoc.data() : null,
            main: mainDoc.exists() ? mainDoc.data() : null
          }
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `wise-fitness-backup-${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showMessage('üì• Backup exported successfully!', 'success');
      } catch (error) {
        showMessage('‚ùå Error exporting backup: ' + error.message, 'error');
      }
    };

    window.validateContent = async () => {
      try {
        showMessage('Validating content...', 'success');
        
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let issues = [];
        
        // Validate About section
        if (aboutDoc.exists()) {
          const aboutData = aboutDoc.data();
          if (!aboutData.title || aboutData.title.trim() === '') {
            issues.push('About section is missing a title');
          }
          if (!aboutData.subtitle || aboutData.subtitle.trim() === '') {
            issues.push('About section is missing a subtitle');
          }
          if (!aboutData.message || aboutData.message.trim() === '') {
            issues.push('About section is missing the main message');
          }
        } else {
          issues.push('About section data not found');
        }
        
        // Validate Services section
        if (servicesDoc.exists()) {
          const servicesData = servicesDoc.data();
          if (!servicesData.title || servicesData.title.trim() === '') {
            issues.push('Services section is missing a title');
          }
          if (!servicesData.services || servicesData.services.length !== 3) {
            issues.push('Services section should have exactly 3 services');
          } else {
            servicesData.services.forEach((service, index) => {
              if (!service.title || service.title.trim() === '') {
                issues.push(`Service ${index + 1} is missing a title`);
              }
              if (!service.description || service.description.trim() === '') {
                issues.push(`Service ${index + 1} is missing a description`);
              }
            });
          }
        } else {
          issues.push('Services section data not found');
        }
        
        if (issues.length === 0) {
          showMessage('‚úÖ All content validation passed! No issues found.', 'success');
        } else {
          showMessage('‚ö†Ô∏è Validation found ' + issues.length + ' issue(s): ' + issues.join(', '), 'error');
        }
        
      } catch (error) {
        showMessage('‚ùå Error during validation: ' + error.message, 'error');
      }
    };

    window.viewAnalytics = async () => {
      try {
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let analytics = {
          aboutSection: {
            hasCustomImages: false,
            imageCount: 0,
            titleLength: 0,
            messageLength: 0
          },
          servicesSection: {
            servicesCount: 0,
            hasCustomImages: 0,
            avgDescriptionLength: 0
          }
        };
        
        if (aboutDoc.exists()) {
          const aboutData = aboutDoc.data();
          analytics.aboutSection.hasCustomImages = aboutData.images && aboutData.images.length > 0;
          analytics.aboutSection.imageCount = aboutData.images ? aboutData.images.length : 0;
          analytics.aboutSection.titleLength = aboutData.title ? aboutData.title.length : 0;
          analytics.aboutSection.messageLength = aboutData.message ? aboutData.message.length : 0;
        }
        
        if (servicesDoc.exists()) {
          const servicesData = servicesDoc.data();
          analytics.servicesSection.servicesCount = servicesData.services ? servicesData.services.length : 0;
          if (servicesData.services) {
            analytics.servicesSection.hasCustomImages = servicesData.services.filter(s => s.imageUrl).length;
            const totalDescLength = servicesData.services.reduce((sum, s) => sum + (s.description ? s.description.length : 0), 0);
            analytics.servicesSection.avgDescriptionLength = Math.round(totalDescLength / servicesData.services.length);
          }
        }
        
        alert(`üìä Content Analytics:
        
About Section:
‚Ä¢ Title length: ${analytics.aboutSection.titleLength} characters
‚Ä¢ Message length: ${analytics.aboutSection.messageLength} characters  
‚Ä¢ Custom images: ${analytics.aboutSection.imageCount} images
        
Services Section:
‚Ä¢ Total services: ${analytics.servicesSection.servicesCount}
‚Ä¢ Services with images: ${analytics.servicesSection.hasCustomImages}
‚Ä¢ Average description length: ${analytics.servicesSection.avgDescriptionLength} characters`);
        
      } catch (error) {
        showMessage('‚ùå Error loading analytics: ' + error.message, 'error');
      }
    };

    window.resetToDefaults = async () => {
      if (!confirm('Are you sure you want to reset all content to the default template? This will restore the original Wise Fitness content and cannot be undone.')) {
        return;
      }
      
      try {
        showMessage('Resetting to default template...', 'success');
        
        // Default About section template
        const defaultAbout = {
          title: "Welcome to Wise Fitness",
          subtitle: "Wise Fitness is more than just a fitness app ‚Äî it's your all-in-one guide to living well.",
          message: "Whether you're training at the gym, exercising at home, or just starting your journey, Wise Fitness supports your goals with the tools and guidance you need to thrive.",
          images: [], // No images in default template
          lastUpdated: new Date(),
          isDefaultTemplate: true
        };
        
        await setDoc(doc(db, "landingPage", "about"), defaultAbout);
        
        // Default Services section template
        const defaultServices = {
          title: "Our Services",
          subtitle: "Comprehensive fitness solutions tailored to your needs",
          services: [
            { 
              title: "üí™ Personal Training", 
              icon: "üí™", 
              description: "One-on-one training sessions tailored to your specific needs and goals.", 
              imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=200&h=200&fit=crop&crop=face" 
            },
            { 
              title: "üë• Group Fitness Classes", 
              icon: "üë•", 
              description: "Fun and motivating group workouts for all fitness levels.", 
              imageUrl: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=200&h=200&fit=crop&crop=face" 
            },
            { 
              title: "ü•ó Nutrition Coaching", 
              icon: "ü•ó", 
              description: "Personalized nutrition plans to support your fitness journey.", 
              imageUrl: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=200&h=200&fit=crop&crop=center" 
            }
          ],
          lastUpdated: new Date(),
          isDefaultTemplate: true
        };
        
        await setDoc(doc(db, "landingPage", "services"), defaultServices);
        
        // Update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          welcomeText: defaultAbout.title,
          slogan: defaultAbout.subtitle,
          aboutSection: defaultAbout.message,
          services: defaultServices.services,
          lastUpdated: new Date(),
          isDefaultTemplate: true
        }, { merge: true });
        
        // Clear any uploaded images from storage and local arrays
        if (aboutImages.length > 0) {
          for (const image of aboutImages) {
            try {
              await deleteObject(image.ref);
            } catch (error) {
              console.warn('Error deleting image:', error);
            }
          }
        }
        aboutImages = [];
        document.getElementById('aboutGallery').innerHTML = '';
        
        // Reload content to reflect reset
        await loadAllContent();
        
        showMessage('‚úÖ Content successfully reset to default template! All sections have been restored to their original state.', 'success');
      } catch (error) {
        console.error('Error resetting to defaults:', error);
        showMessage('‚ùå Error resetting to defaults: ' + error.message, 'error');
      }
    };

    // Sidebar functions
    window.goProfile = () => alert("Go to Profile (not implemented)");
    window.goSettings = () => alert("Go to Settings (not implemented)");

    window.logout = async () => {
      try {
        await signOut(auth);
        window.location.href = "Login.html";
      } catch (error) {
        alert("Logout failed: " + error.message);
      }
    };

    window.resetPassword = () => {
      const user = auth.currentUser;
      if (!user || !user.email) {
        alert("No user logged in.");
        return;
      }
      if (confirm(`Send password reset to ${user.email}?`)) {
        sendPasswordResetEmail(auth, user.email)
          .then(() => alert("Password reset email sent!"))
          .catch(err => alert("Error: " + err.message));
      }
    };

    // Drag and drop for file uploads
    ['aboutImages'].forEach(inputId => {
      const uploadArea = document.querySelector(`#${inputId}`).closest('.upload-area');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        document.getElementById(inputId).files = files;
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        document.getElementById(inputId).dispatchEvent(event);
      });
    });

    // TESTIMONIALS MANAGEMENT FUNCTIONS
    let testimonialStats = { approved: 0, pending: 0, rejected: 0, total: 0 };

    // AI Content Filtering Function - Enhanced with Industry Standard APIs
    async function analyzeContentWithAI(text, rating) {
      try {
        // Option 1: OpenAI Moderation API (Most Reliable)
        const moderationResult = await analyzeWithOpenAIModerattion(text);
        
        // Option 2: Google Cloud Natural Language API (Sentiment Analysis)
        const sentimentResult = await analyzeWithGoogleCloud(text);
        
        // Option 3: Azure Content Moderator (Microsoft)
        const azureResult = await analyzeWithAzure(text);
        
        // Combine results from multiple AI services
        const combinedScore = calculateCombinedScore(moderationResult, sentimentResult, azureResult, rating);
        
        return combinedScore;
        
      } catch (error) {
        console.error('AI API Error, falling back to rule-based analysis:', error);
        // Fallback to rule-based system if APIs fail
        return analyzeWithRuleBasedSystem(text, rating);
      }
    }

    // OpenAI Moderation API Integration
    async function analyzeWithOpenAIModerattion(text) {
      const apiKey = document.getElementById('openaiKey')?.value;
      if (!apiKey) return null;
      
      try {
        const response = await fetch('https://api.openai.com/v1/moderations', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            input: text
          })
        });
        
        const result = await response.json();
        const moderation = result.results[0];
        
        return {
          flagged: moderation.flagged,
          categories: moderation.categories,
          category_scores: moderation.category_scores,
          source: 'openai'
        };
      } catch (error) {
        console.error('OpenAI Moderation API error:', error);
        return null;
      }
    }

    // Google Cloud Natural Language API Integration
    async function analyzeWithGoogleCloud(text) {
      const apiKey = document.getElementById('googleKey')?.value;
      if (!apiKey) return null;
      
      try {
        const response = await fetch(`https://language.googleapis.com/v1/documents:analyzeSentiment?key=${apiKey}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            document: {
              content: text,
              type: 'PLAIN_TEXT'
            }
          })
        });
        
        const result = await response.json();
        
        return {
          sentiment: result.documentSentiment.score, // -1 to 1
          magnitude: result.documentSentiment.magnitude, // 0 to infinity
          source: 'google'
        };
      } catch (error) {
        console.error('Google Cloud API error:', error);
        return null;
      }
    }

    // Azure Content Moderator Integration
    async function analyzeWithAzure(text) {
      const apiKey = document.getElementById('azureKey')?.value;
      const endpoint = document.getElementById('azureEndpoint')?.value;
      if (!apiKey || !endpoint) return null;
      
      try {
        const response = await fetch(`${endpoint}/contentmoderator/moderate/v1.0/ProcessText/Screen`, {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': apiKey,
            'Content-Type': 'text/plain'
          },
          body: text
        });
        
        const result = await response.json();
        
        return {
          terms: result.Terms || [],
          classification: result.Classification,
          source: 'azure'
        };
      } catch (error) {
        console.error('Azure Content Moderator error:', error);
        return null;
      }
    }

    // Combine results from multiple AI services
    function calculateCombinedScore(openai, google, azure, rating) {
      let score = 50;
      let issues = [];
      let confidence = 0;

      // OpenAI Moderation Analysis
      if (openai) {
        confidence += 0.4; // 40% weight
        if (openai.flagged) {
          score -= 40;
          const flaggedCategories = Object.keys(openai.categories).filter(cat => openai.categories[cat]);
          issues.push(`OpenAI flagged: ${flaggedCategories.join(', ')}`);
        } else {
          score += 15;
        }
      }

      // Google Sentiment Analysis
      if (google) {
        confidence += 0.3; // 30% weight
        if (google.sentiment < -0.5) {
          score -= 25;
          issues.push('Negative sentiment detected');
        } else if (google.sentiment > 0.5) {
          score += 15;
          issues.push('Positive sentiment detected');
        }
      }

      // Azure Content Moderation
      if (azure) {
        confidence += 0.3; // 30% weight
        if (azure.terms && azure.terms.length > 0) {
          score -= 30;
          issues.push(`Inappropriate terms detected: ${azure.terms.length} terms`);
        }
      }

      // Rating consistency check
      if (rating >= 4 && score < 30) {
        issues.push('High rating but negative content detected');
        score -= 20;
      }

      if (rating <= 2 && score > 70) {
        issues.push('Low rating but positive content detected');
        score -= 15;
      }

      return {
        score: Math.max(0, Math.min(100, score)),
        issues: issues,
        confidence: confidence,
        recommendation: score >= 70 ? 'approve' : score >= 40 ? 'review' : 'reject',
        aiSources: {
          openai: openai ? 'analyzed' : 'failed',
          google: google ? 'analyzed' : 'failed',
          azure: azure ? 'analyzed' : 'failed'
        }
      };
    }

    // Fallback Rule-Based System (Original)
    function analyzeWithRuleBasedSystem(text, rating) {
      const spamKeywords = ['spam', 'fake', 'bot', 'scam', 'hate', 'terrible', 'worst ever', 'never again'];
      const positiveKeywords = ['great', 'amazing', 'excellent', 'love', 'recommend', 'fantastic', 'wonderful'];
      const lowQualityPatterns = [
        /^.{1,10}$/,  // Too short
        /(.)\1{4,}/,   // Repeated characters
        /^[A-Z\s!]+$/, // All caps
        /^\d+$/,       // Only numbers
      ];

      let score = 50;
      let issues = [];

      const lowerText = text.toLowerCase();
      spamKeywords.forEach(keyword => {
        if (lowerText.includes(keyword)) {
          score -= 30;
          issues.push(`Contains spam keyword: "${keyword}"`);
        }
      });

      positiveKeywords.forEach(keyword => {
        if (lowerText.includes(keyword)) {
          score += 10;
        }
      });

      lowQualityPatterns.forEach(pattern => {
        if (pattern.test(text)) {
          score -= 20;
          issues.push('Low quality content pattern detected');
        }
      });

      if (rating >= 4 && score < 30) {
        issues.push('High rating but negative content detected');
        score -= 25;
      }

      if (rating <= 2 && score > 70) {
        issues.push('Low rating but positive content detected');
        score -= 15;
      }

      return {
        score: Math.max(0, Math.min(100, score)),
        issues: issues,
        confidence: 0.2, // Lower confidence for rule-based
        recommendation: score >= 60 ? 'approve' : score >= 30 ? 'review' : 'reject',
        aiSources: {
          openai: 'fallback',
          google: 'fallback',
          azure: 'fallback'
        }
      };
    }

    // Load testimonials from Firebase
    window.loadTestimonials = async (filter = 'all') => {
      try {
        showMessage('Loading testimonials...', 'success');
        
        let testimonialsRef = db.collection("testimonials");
        
        if (filter !== 'all') {
          testimonialsRef = testimonialsRef.where("status", "==", filter);
        }
        
        const snapshot = await testimonialsRef.orderBy("timestamp", "desc").get();
        const testimonials = [];
        
        snapshot.forEach(doc => {
          testimonials.push({ id: doc.id, ...doc.data() });
        });

        displayTestimonials(testimonials);
        updateTestimonialStats(testimonials);
        
      } catch (error) {
        console.error('Error loading testimonials:', error);
        showMessage('Error loading testimonials: ' + error.message, 'error');
      }
    };

    function displayTestimonials(testimonials) {
      const container = document.getElementById('testimonialsList');
      
      if (testimonials.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No testimonials found</p>';
        return;
      }

      const html = testimonials.map(t => `
        <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: ${getStatusColor(t.status)};">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
            <div style="flex-grow: 1;">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="background: ${getUserTypeColor(t.userType)}; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; text-transform: uppercase;">
                  ${t.userType || 'Unknown'}
                </span>
                <span style="color: #ffc107;">
                  ${'‚òÖ'.repeat(t.rating || 0)}${'‚òÜ'.repeat(5 - (t.rating || 0))}
                </span>
                <span style="font-size: 0.9rem; color: var(--text-muted);">
                  ${t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown date'}
                </span>
              </div>
              <p style="margin: 0.5rem 0; font-style: italic; color: var(--text-light);">
                "${t.text || 'No content'}"
              </p>
              <p style="margin: 0; font-weight: 600; color: var(--text-muted);">
                - ${t.author || 'Anonymous'}
              </p>
              ${t.aiAnalysis ? `
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.8rem;">
                  <strong>AI Score:</strong> ${t.aiAnalysis.score}/100 
                  <strong>Recommendation:</strong> ${t.aiAnalysis.recommendation}
                  ${t.aiAnalysis.confidence ? `<strong>Confidence:</strong> ${Math.round(t.aiAnalysis.confidence * 100)}%` : ''}
                  <br>
                  ${t.aiAnalysis.aiSources ? `<strong>AI Sources:</strong> ${Object.entries(t.aiAnalysis.aiSources).map(([key, value]) => `${key}: ${value}`).join(', ')}` : ''}
                  ${t.aiAnalysis.issues.length > 0 ? `<br><strong>Issues:</strong> ${t.aiAnalysis.issues.join(', ')}` : ''}
                </div>
              ` : ''}
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              ${t.status !== 'approved' ? `<button class="btn btn-success" onclick="updateTestimonialStatus('${t.id}', 'approved')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úÖ Approve</button>` : ''}
              ${t.status !== 'rejected' ? `<button class="btn btn-secondary" onclick="updateTestimonialStatus('${t.id}', 'rejected')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #dc3545;">‚ùå Reject</button>` : ''}
              <button class="btn btn-secondary" onclick="deleteTestimonial('${t.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    function getStatusColor(status) {
      switch(status) {
        case 'approved': return '#e8f5e8';
        case 'rejected': return '#f8d7da';
        case 'pending': return '#fff3cd';
        default: return '#ffffff';
      }
    }

    function getUserTypeColor(userType) {
      switch(userType) {
        case 'freemium': return '#28a745';
        case 'premium': return '#6366f1';
        case 'business': return '#ff6b35';
        default: return '#6c757d';
      }
    }

    function updateTestimonialStats(testimonials) {
      const stats = testimonials.reduce((acc, t) => {
        acc.total++;
        acc[t.status] = (acc[t.status] || 0) + 1;
        return acc;
      }, { approved: 0, pending: 0, rejected: 0, total: 0 });

      document.getElementById('approvedCount').textContent = stats.approved;
      document.getElementById('pendingCount').textContent = stats.pending;
      document.getElementById('rejectedCount').textContent = stats.rejected;
      document.getElementById('totalCount').textContent = stats.total;
      
      testimonialStats = stats;
    }

    // Update testimonial status
    window.updateTestimonialStatus = async (id, status) => {
      try {
        await db.collection("testimonials").doc(id).update({ 
          status: status,
          lastModified: new Date()
        });
        
        showMessage(`Testimonial ${status} successfully!`, 'success');
        loadTestimonials(); // Reload current view
        
      } catch (error) {
        showMessage('Error updating testimonial: ' + error.message, 'error');
      }
    };

    // Delete testimonial
    window.deleteTestimonial = async (id) => {
      if (!confirm('Are you sure you want to permanently delete this testimonial?')) {
        return;
      }
      
      try {
        await db.collection("testimonials").doc(id).delete();
        showMessage('Testimonial deleted successfully!', 'success');
        loadTestimonials(); // Reload current view
        
      } catch (error) {
        showMessage('Error deleting testimonial: ' + error.message, 'error');
      }
    };

    // Bulk approve high-rated reviews
    window.bulkApproveHighRated = async () => {
      try {
        const fiveStarReviews = await db.collection("testimonials")
          .where("status", "==", "pending")
          .where("rating", ">=", 5)
          .get();
        
        const batch = db.batch();
        let count = 0;
        
        fiveStarReviews.forEach(doc => {
          batch.update(doc.ref, { status: 'approved', lastModified: new Date() });
          count++;
        });
        
        if (count > 0) {
          await batch.commit();
          showMessage(`Approved ${count} high-rated testimonials!`, 'success');
          loadTestimonials();
        } else {
          showMessage('No pending 5-star reviews found.', 'success');
        }
        
      } catch (error) {
        showMessage('Error in bulk approval: ' + error.message, 'error');
      }
    };

    // Run AI analysis on pending testimonials
    window.runAIAnalysis = async () => {
      try {
        showMessage('Running AI analysis on pending testimonials...', 'success');
        
        const pendingTestimonials = await db.collection("testimonials")
          .where("status", "==", "pending")
          .get();
        
        const batch = db.batch();
        let analyzed = 0;
        
        for (const doc of pendingTestimonials.docs) {
          const data = doc.data();
          const analysis = await analyzeContentWithAI(data.text, data.rating);
          
          batch.update(doc.ref, {
            aiAnalysis: analysis,
            status: analysis.recommendation === 'reject' ? 'rejected' : 
                   analysis.recommendation === 'approve' ? 'approved' : 'pending',
            lastModified: new Date()
          });
          analyzed++;
        }
        
        if (analyzed > 0) {
          await batch.commit();
          showMessage(`AI analysis completed on ${analyzed} testimonials!`, 'success');
          loadTestimonials();
        } else {
          showMessage('No pending testimonials to analyze.', 'success');
        }
        
      } catch (error) {
        showMessage('Error in AI analysis: ' + error.message, 'error');
      }
    };

    // Update filter settings with AI provider selection
    window.updateFilterSettings = async () => {
      try {
        const settings = {
          aiProvider: document.getElementById('aiProvider')?.value || 'rule-based',
          filterSensitivity: document.getElementById('filterSensitivity').value,
          minRating: parseInt(document.getElementById('minRating').value),
          enableAIFilter: document.getElementById('enableAIFilter').checked,
          apiKeys: {
            openai: document.getElementById('openaiKey')?.value || '',
            google: document.getElementById('googleKey')?.value || '',
            azure: document.getElementById('azureKey')?.value || '',
            azureEndpoint: document.getElementById('azureEndpoint')?.value || ''
          },
          lastUpdated: new Date()
        };
        
        const settingsRef = doc(db, "adminSettings", "testimonialFilters");
        await setDoc(settingsRef, settings);
        showMessage('Filter settings updated successfully!', 'success');
        
      } catch (error) {
        showMessage('Error updating settings: ' + error.message, 'error');
      }
    };

    // Toggle AI settings visibility
    window.toggleAISettings = () => {
      const provider = document.getElementById('aiProvider').value;
      const apiConfig = document.getElementById('apiConfig');
      
      if (provider === 'rule-based') {
        apiConfig.style.display = 'none';
      } else {
        apiConfig.style.display = 'block';
      }
    };

    // Test AI API connections
    window.testAIConnection = async () => {
      const provider = document.getElementById('aiProvider').value;
      showMessage('Testing AI connection...', 'success');
      
      try {
        let testResult = false;
        
        if (provider === 'openai' || provider === 'combined') {
          testResult = await testOpenAIConnection();
        } else if (provider === 'google') {
          testResult = await testGoogleConnection();
        } else if (provider === 'azure') {
          testResult = await testAzureConnection();
        }
        
        if (testResult) {
          showMessage('‚úÖ AI API connection successful!', 'success');
        } else {
          showMessage('‚ùå AI API connection failed. Check your API keys.', 'error');
        }
        
      } catch (error) {
        showMessage('‚ùå AI API test failed: ' + error.message, 'error');
      }
    };

    async function testOpenAIConnection() {
      const apiKey = document.getElementById('openaiKey').value;
      if (!apiKey) return false;
      
      try {
        const response = await fetch('https://api.openai.com/v1/moderations', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ input: 'test message' })
        });
        
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    async function testGoogleConnection() {
      const apiKey = document.getElementById('googleKey').value;
      if (!apiKey) return false;
      
      try {
        const response = await fetch(`https://language.googleapis.com/v1/documents:analyzeSentiment?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            document: { content: 'test message', type: 'PLAIN_TEXT' }
          })
        });
        
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    async function testAzureConnection() {
      const apiKey = document.getElementById('azureKey').value;
      const endpoint = document.getElementById('azureEndpoint').value;
      if (!apiKey || !endpoint) return false;
      
      try {
        const response = await fetch(`${endpoint}/contentmoderator/moderate/v1.0/ProcessText/Screen`, {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': apiKey,
            'Content-Type': 'text/plain'
          },
          body: 'test message'
        });
        
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // Load saved AI settings
    async function loadAISettings() {
      try {
        const settingsDoc = await db.collection("adminSettings").doc("testimonialFilters").get();
        
        if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          
          if (settings.aiProvider && document.getElementById('aiProvider')) {
            document.getElementById('aiProvider').value = settings.aiProvider;
            toggleAISettings();
          }
          
          if (settings.apiKeys) {
            if (document.getElementById('openaiKey')) document.getElementById('openaiKey').value = settings.apiKeys.openai || '';
            if (document.getElementById('googleKey')) document.getElementById('googleKey').value = settings.apiKeys.google || '';
            if (document.getElementById('azureKey')) document.getElementById('azureKey').value = settings.apiKeys.azure || '';
            if (document.getElementById('azureEndpoint')) document.getElementById('azureEndpoint').value = settings.apiKeys.azureEndpoint || '';
          }
        }
      } catch (error) {
        console.error('Error loading AI settings:', error);
      }
    }

    // Export testimonials
    window.exportTestimonials = async () => {
      try {
        const allTestimonials = await db.collection("testimonials").get();
        const data = [];
        
        allTestimonials.forEach(doc => {
          data.push({ id: doc.id, ...doc.data() });
        });
        
        const csv = convertToCSV(data);
        downloadCSV(csv, 'testimonials-export.csv');
        showMessage('Testimonials exported successfully!', 'success');
        
      } catch (error) {
        showMessage('Error exporting testimonials: ' + error.message, 'error');
      }
    };

    function convertToCSV(data) {
      if (data.length === 0) return '';
      
      const headers = ['id', 'author', 'text', 'rating', 'userType', 'status', 'timestamp'];
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(field => {
          let value = row[field] || '';
          if (field === 'timestamp' && value.seconds) {
            value = new Date(value.seconds * 1000).toISOString();
          }
          return `"${String(value).replace(/"/g, '""')}"`;
        }).join(','))
      ].join('\n');
      
      return csvContent;
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('hidden', '');
      a.setAttribute('href', url);
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Generate insights
    window.generateInsights = async () => {
      try {
        const allTestimonials = await db.collection("testimonials").get();
        const testimonials = [];
        
        allTestimonials.forEach(doc => {
          testimonials.push(doc.data());
        });
        
        const insights = {
          totalReviews: testimonials.length,
          averageRating: testimonials.reduce((sum, t) => sum + (t.rating || 0), 0) / (testimonials.length || 1),
          userTypeBreakdown: testimonials.reduce((acc, t) => {
            acc[t.userType] = (acc[t.userType] || 0) + 1;
            return acc;
          }, {}),
          statusBreakdown: testimonials.reduce((acc, t) => {
            acc[t.status] = (acc[t.status] || 0) + 1;
            return acc;
          }, {}),
          recentTrends: getRecentTrends(testimonials)
        };
        
        displayInsights(insights);
        
      } catch (error) {
        showMessage('Error generating insights: ' + error.message, 'error');
      }
    };

    function getRecentTrends(testimonials) {
      const last30Days = testimonials.filter(t => {
        if (!t.timestamp) return false;
        const date = new Date(t.timestamp.seconds * 1000);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return date >= thirtyDaysAgo;
      });
      
      return {
        recentCount: last30Days.length,
        recentAverage: last30Days.reduce((sum, t) => sum + (t.rating || 0), 0) / (last30Days.length || 1)
      };
    }

    function displayInsights(insights) {
      alert(`üìä Testimonial Insights:
      
üìà Overall Statistics:
‚Ä¢ Total Reviews: ${insights.totalReviews}
‚Ä¢ Average Rating: ${insights.averageRating.toFixed(1)}/5
‚Ä¢ Recent (30 days): ${insights.recentTrends.recentCount} reviews
‚Ä¢ Recent Average: ${insights.recentTrends.recentAverage.toFixed(1)}/5

üë• User Type Breakdown:
‚Ä¢ Freemium: ${insights.userTypeBreakdown.freemium || 0}
‚Ä¢ Premium: ${insights.userTypeBreakdown.premium || 0}  
‚Ä¢ Business: ${insights.userTypeBreakdown.business || 0}

üìã Status Breakdown:
‚Ä¢ Approved: ${insights.statusBreakdown.approved || 0}
‚Ä¢ Pending: ${insights.statusBreakdown.pending || 0}
‚Ä¢ Rejected: ${insights.statusBreakdown.rejected || 0}`);
    }
  </script>
</body>
</html>