<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Landing Page - Wise Fitness</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-hover: #0056b3;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light-bg: #f9f9f9;
      --card-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.12);
      --radius: 14px;
      --text-light: #222;
      --text-muted: #6c757d;
      --border-color: #e9ecef;
      --transition: 0.3s ease;
      --dark-bg: #1a1a1a;
      --dark-card: #2c2c2c;
      --text-dark: #f1f1f1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      background: var(--light-bg);
      color: var(--text-light);
      transition: var(--transition);
    }

    body.dark {
      background: var(--dark-bg);
      color: var(--text-dark);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      transition: padding-right var(--transition);
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 260px;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: -2px 0 12px rgba(0, 0, 0, 0.1);
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border-radius: 14px 0 0 14px;
      transform: translateX(100%);
      transition: transform var(--transition);
      z-index: 30;
      overflow-y: auto;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar button {
      background: var(--light-bg);
      border: none;
      border-radius: var(--radius);
      padding: 14px 22px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      color: var(--text-light);
      text-align: left;
      transition: background-color var(--transition), color var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar button:hover {
      background: var(--primary);
      color: white;
    }

    /* Toolbar styles (from SystemAdmin.html) */
    header.toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #0066cc;
      padding: 8px 16px;
      color: white;
      border-radius: 5px;
      user-select: none;
      margin-bottom: 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 20;
      height: 56px;
    }
    header.toolbar > div {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header.toolbar button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      user-select: none;
    }
    #modeToggle {
      font-size: 20px;
    }
    #menuBtn {
      font-size: 24px;
    }
    header.toolbar span.title {
      font-weight: 600;
      font-size: 18px;
    }
    /* Side Menu styles (from SystemAdmin.html) */
    #sideMenuOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1500;
      transition: opacity 0.3s ease;
    }
    #sideMenuOverlay.active {
      display: block;
    }
    #sideMenu {
      position: fixed;
      top: 0;
      right: -280px;
      left: auto;
      width: 280px;
      height: 100vh;
      background-color: #004a99;
      color: white;
      padding: 20px;
      box-sizing: border-box;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
      transition: right 0.3s ease;
      z-index: 1600;
      display: flex;
      flex-direction: column;
    }
    #sideMenu.active {
      right: 0;
      left: auto;
    }
    #sideMenu h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 22px;
    }
    #sideMenu nav a, #sideMenu button.menu-btn {
      color: white;
      text-decoration: none;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
      font-size: 16px;
      display: block;
      background: none;
      border: none;
      text-align: left;
    }
    #sideMenu nav a:hover, #sideMenu button.menu-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    #sideMenu button#closeMenuBtn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      align-self: flex-end;
      cursor: pointer;
      margin-bottom: 10px;
    }

    /* HEADER */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: var(--shadow);
      z-index: 100;
      border-radius: 0 0 var(--radius) var(--radius);
      transition: right var(--transition), width var(--transition);
    }

    body.sidebar-active .header {
      right: 260px;
      width: calc(100% - 260px);
    }

    #backBtn,
    #menuBtn {
      background: transparent;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .headerTitle {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      flex-grow: 1;
      margin: 0 12px;
    }

    /* MAIN CONTAINER */
    .container {
      max-width: 1000px;
      margin: 80px auto 40px;
      padding: 24px 20px;
      transition: padding-right var(--transition);
      overflow-y: auto;
    }

    body.sidebar-active .container {
      padding-right: 280px;
    }

    /* SECTION CARDS */
    .section-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      padding: 1.5rem 2rem;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .section-header:hover {
      background: linear-gradient(135deg, var(--primary-hover) 0%, #003d82 100%);
    }

    .section-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .section-content.active {
      padding: 2rem;
      max-height: 2000px;
    }

    .toggle-icon {
      transition: transform var(--transition);
      font-size: 1.2rem;
    }

    .section-card.active .toggle-icon {
      transform: rotate(180deg);
    }

    /* FORM ELEMENTS */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    input[type="text"], 
    input[type="url"],
    textarea, 
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      transition: var(--transition);
      background: #fff;
      font-family: inherit;
    }

    input:focus, 
    textarea:focus, 
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* FILE UPLOAD */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      background: #fafafa;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(0, 123, 255, 0.05);
    }

    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(0, 123, 255, 0.1);
    }

    .file-input {
      display: none;
    }

    .upload-text {
      margin-top: 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* IMAGE GALLERY */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      aspect-ratio: 1;
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* SERVICE ITEM */
    .service-item-editor {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      background: #fafafa;
    }

    .service-item-header {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }

    /* BUTTONS */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      text-align: center;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-block {
      width: 100%;
      margin-top: 1rem;
    }

    /* PROGRESS BAR */
    .progress {
      width: 100%;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* MESSAGES */
    .message {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      font-weight: 600;
      text-align: center;
    }

    .message.success {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .message.error {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        margin: 70px 10px 20px;
        padding: 16px;
      }

      body.sidebar-active .container {
        padding-right: 16px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .section-content.active {
        padding: 1rem;
      }
    }

    /* COMPREHENSIVE RESPONSIVE BREAKPOINTS */
    
    /* Large tablets and small laptops - 768px to 1024px */
    @media (max-width: 1024px) and (min-width: 769px) {
      .container {
        max-width: 900px;
        padding: 20px 16px;
      }
      
      .section-content.active {
        padding: 1.5rem;
      }
      
      .form-row {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      
      .sidebar {
        width: 240px;
      }
      
      body.sidebar-active .container {
        padding-right: 260px;
      }
    }
    
    /* Tablets and large phones - iPads, Galaxy tablets, etc. */
    @media (max-width: 768px) {
      .container {
        margin: 70px 8px 20px;
        padding: 12px;
      }
      
      .section-card {
        margin-bottom: 1.5rem;
      }
      
      .section-content.active {
        padding: 1rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      .btn {
        padding: 10px 20px;
        font-size: 0.9rem;
      }
      
      .headerTitle {
        font-size: 16px;
      }
      
      .sidebar {
        width: 280px;
      }
      
      body.sidebar-active .container {
        padding-right: 12px;
      }
      
      body.sidebar-active .header {
        right: 0;
        width: 100%;
      }
      
      /* Price Plans Grid on Tablets */
      #pricing-content form > div:first-child {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
      }
    }
    
    /* Standard smartphones - iPhone 14/15, Galaxy S23/S24, Pixel 8 (390-430px width) */
    @media (max-width: 480px) {
      .container {
        margin: 65px 4px 15px;
        padding: 8px;
      }
      
      .section-header {
        padding: 1rem 1.5rem;
        font-size: 1rem;
      }
      
      .section-content.active {
        padding: 0.75rem;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      input[type="text"], 
      input[type="url"],
      input[type="number"],
      textarea, 
      select {
        padding: 10px 12px;
        font-size: 0.9rem;
      }
      
      .btn {
        padding: 8px 16px;
        font-size: 0.85rem;
      }
      
      .btn-block {
        margin-top: 0.75rem;
      }
      
      .headerTitle {
        font-size: 14px;
      }
      
      #backBtn, #menuBtn {
        font-size: 20px;
      }
      
      /* Price Plans on Mobile */
      #pricing-content form > div:first-child {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        margin-bottom: 1rem !important;
      }
      
      #pricing-content form > div:first-child > div {
        padding: 1rem !important;
      }
      
      #pricing-content form > div:first-child h4 {
        font-size: 1rem !important;
      }
    }
    
    /* Small smartphones - iPhone SE, iPhone 12/13 Mini (360-375px width) */
    @media (max-width: 375px) {
      .container {
        margin: 60px 2px 10px;
        padding: 6px;
      }
      
      .section-header {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }
      
      .section-content.active {
        padding: 0.5rem;
      }
      
      .form-group {
        margin-bottom: 0.75rem;
      }
      
      input[type="text"], 
      input[type="url"],
      input[type="number"],
      textarea, 
      select {
        padding: 8px 10px;
        font-size: 0.85rem;
      }
      
      textarea {
        min-height: 80px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      
      .headerTitle {
        font-size: 12px;
      }
      
      label {
        font-size: 0.8rem;
      }
      
      small {
        font-size: 0.7rem;
      }
    }
    
    /* Extra small smartphones - iPhone SE 1st gen, very small devices (< 360px) */
    @media (max-width: 360px) {
      .container {
        margin: 58px 1px 8px;
        padding: 4px;
      }
      
      .section-header {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }
      
      .section-content.active {
        padding: 0.375rem;
      }
      
      .form-group {
        margin-bottom: 0.5rem;
      }
      
      input[type="text"], 
      input[type="url"],
      input[type="number"],
      textarea, 
      select {
        padding: 6px 8px;
        font-size: 0.8rem;
      }
      
      .btn {
        padding: 5px 10px;
        font-size: 0.75rem;
      }
      
      .headerTitle {
        font-size: 11px;
      }
    }
    
    /* Foldable phones - cover screen mode (around 412px but can be narrower when folded) */
    @media (max-width: 412px) and (min-width: 376px) {
      .container {
        margin: 65px 3px 12px;
        padding: 7px;
      }
      
      .section-content.active {
        padding: 0.625rem;
      }
      
      /* Optimize for foldable cover screens */
      .form-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .section-header {
        padding: 0.875rem 1.25rem;
      }
    }
    
    /* Large smartphones and phablets - Galaxy Note, iPhone Pro Max (414-430px) */
    @media (max-width: 430px) and (min-width: 415px) {
      .container {
        margin: 68px 5px 15px;
        padding: 10px;
      }
      
      .section-content.active {
        padding: 0.875rem;
      }
      
      input[type="text"], 
      input[type="url"],
      input[type="number"],
      textarea, 
      select {
        padding: 9px 11px;
        font-size: 0.875rem;
      }
    }
    
    /* Standard size smartphones - most common range (390-414px) */
    @media (max-width: 414px) and (min-width: 390px) {
      .container {
        margin: 66px 4px 14px;
        padding: 9px;
      }
      
      .section-content.active {
        padding: 0.75rem;
      }
      
      .form-group {
        margin-bottom: 0.875rem;
      }
    }
    
    /* Compact smartphones - iPhone 12/13 Mini, smaller Androids (360-389px) */
    @media (max-width: 389px) and (min-width: 360px) {
      .container {
        margin: 62px 3px 12px;
        padding: 7px;
      }
      
      .section-content.active {
        padding: 0.625rem;
      }
      
      .form-group {
        margin-bottom: 0.625rem;
      }
      
      textarea {
        min-height: 70px;
      }
    }
    
    /* Small smartphones - iPhone SE, older devices (< 360px) */
    @media (max-width: 359px) {
      .container {
        margin: 58px 1px 8px;
        padding: 4px;
      }
      
      .section-content.active {
        padding: 0.375rem;
      }
      
      textarea {
        min-height: 60px;
      }
      
      /* Make sure form elements are still usable on very small screens */
      .form-group {
        margin-bottom: 0.375rem;
      }
      
      .btn-block {
        margin-top: 0.5rem;
      }
    }
    
    /* Universal mobile styles that apply to all small screens */
    @media (max-width: 768px) {
      /* Hide sidebar by default on mobile */
      .sidebar {
        transform: translateX(100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      /* Ensure mobile menu works properly */
      #menuBtn {
        display: block;
      }
      
      /* Optimize form layout for mobile */
      .form-row {
        grid-template-columns: 1fr;
      }
      
      /* Better touch targets */
      .btn {
        min-height: 44px;
        touch-action: manipulation;
      }
      
      /* Improve text readability */
      label {
        font-weight: 600;
        margin-bottom: 0.375rem;
      }
      
      /* Better mobile typography */
      .section-title {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
      }
      
      .section-subtitle {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      }
    }

    /* TESTIMONIALS TABLE STYLES */
    .testimonials-dashboard {
      margin-bottom: 2rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border-left: 4px solid;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .dashboard-card.total {
      border-left-color: var(--primary);
    }

    .dashboard-card.business {
      border-left-color: #17a2b8;
    }

    .dashboard-card.basic {
      border-left-color: #28a745;
    }

    .dashboard-card.premium {
      border-left-color: #ffc107;
    }

    .dashboard-icon {
      font-size: 2rem;
      opacity: 0.8;
    }

    .dashboard-content h3 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-light);
    }

    .dashboard-content p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .testimonials-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-top: 1rem;
    }

    .testimonials-table th,
    .testimonials-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .testimonials-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .testimonials-table tr:hover {
      background: rgba(0, 123, 255, 0.05);
    }

    .testimonials-table tr:last-child td {
      border-bottom: none;
    }

    .rating-stars {
      color: #ffc107;
      font-size: 1.1rem;
    }

    .user-type-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .user-type-business {
      background: #e3f2fd;
      color: #1565c0;
    }

    .user-type-basic {
      background: #e8f5e8;
      color: #2e7d32;
    }

    .user-type-premium {
      background: #fff8e1;
      color: #f57c00;
    }

    .user-type-normal {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .feedback-text {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .loading-text {
      text-align: center;
      color: var(--text-muted);
      padding: 2rem;
      font-style: italic;
    }

    /* TESTIMONIALS MODAL STYLES */
    .testimonials-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .testimonials-modal-content {
      background-color: white;
      margin: 2% auto;
      border-radius: 12px;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary), #0056b3);
      color: white;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 12px 12px 0 0;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .close-modal:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .modal-filters {
      background: #f8f9fa;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-group label {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .filter-select, .filter-input {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      background: white;
    }

    .ai-analyze-btn {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .ai-analyze-btn:hover {
      transform: translateY(-1px);
    }

    .ai-analyze-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .modal-body {
      flex: 1;
      overflow: auto;
      padding: 0;
    }

    .ai-sentiment-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .sentiment-positive {
      background: #d4edda;
      color: #155724;
    }

    .sentiment-negative {
      background: #f8d7da;
      color: #721c24;
    }

    .sentiment-neutral {
      background: #e2e3e5;
      color: #383d41;
    }

    .sentiment-spam {
      background: #ffeaa7;
      color: #d63031;
    }

    .sentiment-inappropriate {
      background: #fd79a8;
      color: #2d3436;
    }

    .feedback-full {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-width: 250px;
      line-height: 1.4;
    }

    .feedback-preview {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      color: var(--primary);
      max-width: 250px;
    }

    .feedback-preview:hover {
      text-decoration: underline;
    }

    .ai-score {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      gap: 0.5rem;
      background: #f8f9fa;
      border-top: 1px solid var(--border-color);
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary);
      color: white;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .current-page {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
  </style>
</head>
<body>

  <div id="sideMenuOverlay" tabindex="-1"></div>
  <aside id="sideMenu" aria-label="Main menu" role="navigation">
    <button id="closeMenuBtn" aria-label="Close menu" title="Close menu">√ó</button>
    <h2>Menu</h2>
    <nav>
      <button class="menu-btn" onclick="location.href='SystemAdmin.html'">Dashboard</button>
      <button class="menu-btn" onclick="location.href='ManageUsers.html'">Manage User</button>
      <button class="menu-btn" onclick="location.href='ManageBusiness.html'">Manage Business</button>
      <button class="menu-btn" onclick="location.href='ManageLandingPage.html'">Manage Landing Page</button>
      <button class="menu-btn" onclick="window.open('index.html', '_blank')" style="background: rgba(40, 167, 69, 0.2); border-radius: 4px;">üîç Preview Landing Page</button>
      <button class="menu-btn" onclick="sendPasswordReset()">Reset Password</button>
      <button class="menu-btn" onclick="logout()">Logout</button>
    </nav>
  </aside>
  <header class="toolbar" role="banner" aria-label="Page toolbar">
    <div style="display: flex; align-items: center; gap: 8px;">
      <button id="backBtn" aria-label="Back" title="Back" style="background: none; border: none; color: white; font-size: 22px; cursor: pointer;">‚Üê</button>
      <span class="title">Manage Landing Page</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <button id="modeToggle" aria-label="Toggle light/dark mode" title="Toggle light/dark mode">üåô</button>
      <button id="menuBtn" aria-label="Open menu" title="Open menu">‚ò∞</button>
    </div>
  </header>

  <!-- Main Form -->
  <main class="container">
    <div id="globalMessage" class="message" style="display: none;"></div>

    <!-- About Us Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('about')">
        <span>üìù About Us Section</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="about-content">
        <form id="aboutForm">
          <div class="form-group">
            <label for="aboutTitle">Section Title</label>
            <input type="text" id="aboutTitle" placeholder="e.g., Welcome to Wise Fitness">
          </div>

          <div class="form-group">
            <label for="aboutSubtitle">Section Subtitle</label>
            <textarea id="aboutSubtitle" rows="2" placeholder="Brief description..."></textarea>
          </div>

          <div class="form-group">
            <label for="aboutMessage">Main Message</label>
            <textarea id="aboutMessage" rows="4" placeholder="Detailed about us content..."></textarea>
          </div>

          <div class="form-group">
            <label>Image Gallery (Optional)</label>
            <div class="upload-area" onclick="document.getElementById('aboutImages').click()">
              <div style="font-size: 2rem;">üì∑</div>
              <div class="upload-text">Click to upload images or drag and drop</div>
              <input type="file" id="aboutImages" class="file-input" multiple accept="image/*">
            </div>
            <div class="progress" id="aboutProgress" style="display: none;">
              <div class="progress-bar" id="aboutProgressBar"></div>
            </div>
            <div class="image-gallery" id="aboutGallery"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">üíæ Save About Us</button>
        </form>
      </div>
    </div>

    <!-- Services Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('services')">
        <span>üõ†Ô∏è Our Services Section</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="services-content">
        <form id="servicesForm">
          <div class="form-group">
            <label for="servicesTitle">Section Title</label>
            <input type="text" id="servicesTitle" placeholder="e.g., Our Services">
          </div>

          <div class="form-group">
            <label for="servicesSubtitle">Section Subtitle</label>
            <textarea id="servicesSubtitle" rows="2" placeholder="Services description..."></textarea>
          </div>

          <!-- Service Item 1 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 1</div>
            <div class="form-row">
              <div>
                <label for="service1Title">Title</label>
                <input type="text" id="service1Title" placeholder="Service title">
              </div>
              <div>
                <label for="service1Icon">Icon/Emoji</label>
                <input type="text" id="service1Icon" placeholder="üí™">
              </div>
            </div>
            <div class="form-group">
              <label for="service1Desc">Description</label>
              <textarea id="service1Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service1Image">Image URL (Optional)</label>
              <input type="url" id="service1Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <!-- Service Item 2 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 2</div>
            <div class="form-row">
              <div>
                <label for="service2Title">Title</label>
                <input type="text" id="service2Title" placeholder="Service title">
              </div>
              <div>
                <label for="service2Icon">Icon/Emoji</label>
                <input type="text" id="service2Icon" placeholder="üë•">
              </div>
            </div>
            <div class="form-group">
              <label for="service2Desc">Description</label>
              <textarea id="service2Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service2Image">Image URL (Optional)</label>
              <input type="url" id="service2Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <!-- Service Item 3 -->
          <div class="service-item-editor">
            <div class="service-item-header">Service 3</div>
            <div class="form-row">
              <div>
                <label for="service3Title">Title</label>
                <input type="text" id="service3Title" placeholder="Service title">
              </div>
              <div>
                <label for="service3Icon">Icon/Emoji</label>
                <input type="text" id="service3Icon" placeholder="ü•ó">
              </div>
            </div>
            <div class="form-group">
              <label for="service3Desc">Description</label>
              <textarea id="service3Desc" rows="3" placeholder="Service description..."></textarea>
            </div>
            <div class="form-group">
              <label for="service3Image">Image URL (Optional)</label>
              <input type="url" id="service3Image" placeholder="https://images.unsplash.com/...">
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">üõ†Ô∏è Save Services</button>
        </form>
      </div>
    </div>

    <!-- Price Plans Management Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('pricing')">
        <span>üí∞ Price Plans Management</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="pricing-content">
        <form id="pricingForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            
            <!-- Free Plan -->
            <div style="border: 2px solid #28a745; border-radius: 12px; padding: 1.5rem; background: #f8fff8;">
              <h4 style="color: #28a745; margin-bottom: 1rem; text-align: center;">üÜì Free Plan</h4>
              
              <div class="form-group">
                <label for="freePlanTitle">Plan Title</label>
                <input type="text" id="freePlanTitle" value="Free" placeholder="e.g., Free, Basic, Starter">
              </div>
              
              <div class="form-group">
                <label for="freePlanPrice">Price (in dollars)</label>
                <input type="number" id="freePlanPrice" step="0.01" min="0" max="9999.99" value="0" placeholder="0.00" oninput="validatePrice(this)">
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                  Enter price in dollars, e.g., 0.90 for $0.90/month or 10.00 for $10.00/month (no negative values)
                </small>
              </div>
              
              <div class="form-group">
                <label for="freePlanFeatures">Features (one per line, max 700 words)</label>
                <textarea id="freePlanFeatures" rows="8" placeholder="‚úì Access to basic workouts&#10;‚úì Limited exercise tracking&#10;‚úì Daily reminders&#10;‚úó Personalized training&#10;‚úó Nutrition planning">‚úì Access to basic workouts
‚úì Limited exercise tracking
‚úì Daily reminders
‚úó Personalized training
‚úó Nutrition planning</textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                  Word count: <span id="freeFeaturesCount">18</span>/700
                </small>
              </div>
              
              <div class="form-group">
                <label for="freePlanButton">Button Text</label>
                <input type="text" id="freePlanButton" value="Get Started" placeholder="Get Started, Sign Up, etc.">
              </div>
            </div>
            
            <!-- Premium Plan -->
            <div style="border: 2px solid #ff6b35; border-radius: 12px; padding: 1.5rem; background: #fff8f5; position: relative;">
              <div style="position: absolute; top: -12px; right: 20px; background: #ff6b35; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                MOST POPULAR
              </div>
              <h4 style="color: #ff6b35; margin-bottom: 1rem; text-align: center;">‚≠ê Premium Plan</h4>
              
              <div class="form-group">
                <label for="premiumPlanTitle">Plan Title</label>
                <input type="text" id="premiumPlanTitle" value="Premium" placeholder="e.g., Premium, Pro, Advanced">
              </div>
              
              <div class="form-group">
                <label for="premiumPlanPrice">Price (in dollars)</label>
                <input type="number" id="premiumPlanPrice" step="0.01" min="0" max="9999.99" value="10.00" placeholder="10.00" oninput="validatePrice(this)">
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                  Enter price in dollars, e.g., 9.99 for $9.99/month or 19.99 for $19.99/month (no negative values)
                </small>
              </div>
              
              <div class="form-group">
                <label for="premiumPlanFeatures">Features (one per line, max 700 words)</label>
                <textarea id="premiumPlanFeatures" rows="8" placeholder="‚úì All Free features&#10;‚úì Personalized fitness plans&#10;‚úì Full workout library&#10;‚úì Nutrition and meal guidance&#10;‚úì Progress tracking and analytics">‚úì All Free features
‚úì Personalized fitness plans
‚úì Full workout library
‚úì Nutrition and meal guidance
‚úì Progress tracking and analytics</textarea>
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                  Word count: <span id="premiumFeaturesCount">22</span>/700
                </small>
              </div>
              
              <div class="form-group">
                <label for="premiumPlanButton">Button Text</label>
                <input type="text" id="premiumPlanButton" value="Start Premium" placeholder="Start Premium, Upgrade Now, etc.">
              </div>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 40px; font-size: 1.1rem;">
              üíæ Save Price Plans
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Testimonials Management Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('testimonials')">
        <span>üí¨ Testimonials Management</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="testimonials-content">
        <!-- Testimonials Dashboard -->
        <div id="testimonials-dashboard" class="testimonials-dashboard" style="display: none;">
          <div class="dashboard-grid">
            <div class="dashboard-card total">
              <div class="dashboard-icon">üìä</div>
              <div class="dashboard-content">
                <h3 id="total-reviews">0</h3>
                <p>Total Reviews</p>
              </div>
            </div>
            
            <div class="dashboard-card business">
              <div class="dashboard-icon">üè¢</div>
              <div class="dashboard-content">
                <h3 id="business-reviews">0</h3>
                <p>Business User Reviews</p>
              </div>
            </div>
            
            <div class="dashboard-card basic">
              <div class="dashboard-icon">üë§</div>
              <div class="dashboard-content">
                <h3 id="basic-reviews">0</h3>
                <p>Basic User Reviews</p>
              </div>
            </div>
            
            <div class="dashboard-card premium">
              <div class="dashboard-icon">‚≠ê</div>
              <div class="dashboard-content">
                <h3 id="premium-reviews">0</h3>
                <p>Premium User Reviews</p>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <button onclick="openTestimonialsModal()" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            üîç View All Testimonials
          </button>
          <button onclick="loadTestimonials()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            üìä Refresh Dashboard
          </button>
          <span id="testimonial-count" style="color: var(--text-muted); font-size: 0.9rem;"></span>
        </div>
        
        <div id="testimonials-table-container">
          <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
            Use the dashboard above to see testimonial statistics, or click "View All Testimonials" to see detailed data with AI filtering.
          </p>
        </div>
      </div>
    </div>

    <!-- Testimonials Modal -->
    <div id="testimonials-modal" class="testimonials-modal">
      <div class="testimonials-modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ü§ñ AI-Powered Testimonials Management</h2>
          <button class="close-modal" onclick="closeTestimonialsModal()">&times;</button>
        </div>
        
        <div class="modal-filters">
          <div class="filter-group">
            <label>Membership:</label>
            <select id="filter-membership" class="filter-select" onchange="filterTestimonials()">
              <option value="">All Types</option>
              <option value="business">Business</option>
              <option value="premium">Premium</option>
              <option value="basic">Basic</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Rating:</label>
            <select id="filter-rating" class="filter-select" onchange="filterTestimonials()">
              <option value="">All Ratings</option>
              <option value="5">5 Stars (Excellent)</option>
              <option value="4">4 Stars (Good)</option>
              <option value="low">3 Stars & Below (Needs Improvement)</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>AI Sentiment:</label>
            <select id="filter-sentiment" class="filter-select" onchange="filterTestimonials()">
              <option value="">All Sentiments</option>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Search:</label>
            <input type="text" id="filter-search" class="filter-input" placeholder="Search feedback..." onkeyup="filterTestimonials()">
          </div>
          
          <div class="filter-group">
            <button onclick="clearAllFilters()" class="clear-filters-btn" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">Clear All Filters</button>
          </div>
          
          <button id="ai-analyze-all" class="ai-analyze-btn" onclick="analyzeAllTestimonials()" title="Analyze all testimonials with AI">
            ü§ñ AI Analysis
          </button>
          
          <button onclick="refreshTestimonials()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer;" title="Refresh testimonials data">
            üîÑ Refresh
          </button>
          
          <button onclick="testOpenAI()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer;" title="Test OpenAI API connection">
            üß™ Test API
          </button>
        </div>
        
        <div class="modal-body">
          <div id="modal-testimonials-content">
            <p class="loading-text">Loading testimonials...</p>
          </div>
        </div>
        
        <div class="pagination" id="testimonials-pagination" style="display: none;">
          <button onclick="changePage(-1)">Previous</button>
          <span id="page-info">Page 1 of 1</span>
          <button onclick="changePage(1)">Next</button>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection('actions')">
        <span>‚ö° Quick Actions & Template Management</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="section-content" id="actions-content">
        <div style="margin-bottom: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">üîÑ Template Management</h4>
          <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
            The reset function will restore all content to the original Wise Fitness template. This includes restoring default text, removing custom images, and resetting all service configurations. The testimonials section will not be affected as it's dynamically loaded from user reviews.
          </p>
          <button class="btn btn-secondary" onclick="resetToDefaults()" style="background: #dc3545; border: none; margin-bottom: 1rem; width: 100%;">
            üîÑ Reset to Default Template
          </button>
        </div>
        
        <div style="border-top: 1px solid var(--border-color); padding-top: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">üîß Admin Tools</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-secondary" onclick="previewLandingPage()">üëÅÔ∏è Preview Landing Page</button>
            <button class="btn btn-secondary" onclick="exportBackup()">üì• Export Content Backup</button>
            <button class="btn btn-secondary" onclick="validateContent()">‚úÖ Validate All Content</button>
            <button class="btn btn-secondary" onclick="viewAnalytics()">üìä View Content Analytics</button>
          </div>
        </div>
        
        <div style="border-top: 1px solid var(--border-color); padding-top: 2rem; margin-top: 2rem;">
          <h4 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">‚ÑπÔ∏è Template Information</h4>
          <div style="background: var(--light-bg); padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: var(--text-muted);">
            <p><strong>Current Template:</strong> Wise Fitness Default v1.0</p>
            <p><strong>Last Modified:</strong> <span id="lastModified">Loading...</span></p>
            <p><strong>Sections Managed:</strong> About Us, Services, Price Plans (Testimonials are dynamic)</p>
            <p><strong>Image Storage:</strong> Firebase Storage with automatic cleanup</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Import additional Firestore functions for testimonials
    import { 
      collection, 
      query, 
      where, 
      orderBy, 
      getDocs, 
      addDoc, 
      updateDoc, 
      deleteDoc,
      writeBatch 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ===========================================================================
    // IMPORTANT: AI FILTERING CONFIGURATION
    // ===========================================================================
    // To enable AI-powered testimonial analysis, you need to:
    // 1. Get an OpenAI API key from https://platform.openai.com/api-keys
    // 2. Replace 'your-openai-api-key-here' in the OPENAI_API_KEY variable below
    // 3. The AI will analyze testimonials for:
    //    - Sentiment (positive, negative, neutral)
    //    - Spam detection
    //    - Inappropriate content detection
    //    - Confidence scores
    // Industry standard: OpenAI GPT models are widely used for content moderation
    // ===========================================================================

    const firebaseConfig = {
      apiKey: "AIzaSyAIFV7ynXUzA0p-CrmVOE2lFRgaf_9g_k4",
      authDomain: "fyp-25-s2-09.firebaseapp.com",
      projectId: "fyp-25-s2-09",
      storageBucket: "fyp-25-s2-09.appspot.com",
      messagingSenderId: "838641447649",
      appId: "1:838641447649:web:6ddfb234b3d445f16dbda0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const globalMessage = document.getElementById("globalMessage");
    const sideMenu = document.getElementById("sideMenu");
    const sideMenuOverlay = document.getElementById("sideMenuOverlay");
    const menuBtn = document.getElementById("menuBtn");
    const closeMenuBtn = document.getElementById("closeMenuBtn");
    const modeToggle = document.getElementById("modeToggle");

    // Global variables for uploaded images
    let aboutImages = [];

    // Side menu functionality
    menuBtn.addEventListener("click", () => {
      sideMenu.classList.add("active");
      sideMenuOverlay.classList.add("active");
    });

    closeMenuBtn.addEventListener("click", () => {
      sideMenu.classList.remove("active");
      sideMenuOverlay.classList.remove("active");
    });

    sideMenuOverlay.addEventListener("click", () => {
      sideMenu.classList.remove("active");
      sideMenuOverlay.classList.remove("active");
    });

    // Back button functionality
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "SystemAdmin.html";
    });

    // Mode toggle functionality
    modeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      modeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // Load saved theme
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
      modeToggle.textContent = "‚òÄÔ∏è";
    }

    // Toggle sections
    window.toggleSection = (sectionId) => {
      const content = document.getElementById(sectionId + '-content');
      const card = content.closest('.section-card');
      
      if (content.classList.contains('active')) {
        content.classList.remove('active');
        card.classList.remove('active');
      } else {
        // Close all other sections
        document.querySelectorAll('.section-content').forEach(el => {
          el.classList.remove('active');
          el.closest('.section-card').classList.remove('active');
        });
        
        content.classList.add('active');
        card.classList.add('active');
      }
    };

    // Show message function
    function showMessage(message, type = 'success') {
      globalMessage.textContent = message;
      globalMessage.className = `message ${type}`;
      globalMessage.style.display = 'block';
      
      setTimeout(() => {
        globalMessage.style.display = 'none';
      }, 5000);
    }

    // File upload handlers
    document.getElementById('aboutImages').addEventListener('change', handleAboutImageUpload);

    async function handleAboutImageUpload(event) {
      const files = Array.from(event.target.files);
      const progressBar = document.getElementById('aboutProgressBar');
      const progress = document.getElementById('aboutProgress');
      
      if (files.length === 0) return;
      
      progress.style.display = 'block';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        try {
          // Create unique filename
          const timestamp = Date.now();
          const filename = `about_${timestamp}_${i}_${file.name}`;
          const storageRef = ref(storage, `landing-page/about/${filename}`);
          
          // Upload file
          const snapshot = await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          
          // Add to images array
          aboutImages.push({
            url: downloadURL,
            filename: filename,
            ref: storageRef
          });
          
          // Update progress
          const progressPercent = ((i + 1) / files.length) * 100;
          progressBar.style.width = progressPercent + '%';
          
          // Add to gallery
          addImageToGallery(downloadURL, filename, 'about');
          
        } catch (error) {
          console.error('Error uploading image:', error);
          showMessage(`Error uploading ${file.name}: ${error.message}`, 'error');
        }
      }
      
      progress.style.display = 'none';
      progressBar.style.width = '0%';
      
      showMessage(`Successfully uploaded ${files.length} image(s)`, 'success');
    }

    function addImageToGallery(url, filename, galleryType) {
      const gallery = document.getElementById(galleryType + 'Gallery');
      
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      imageItem.innerHTML = `
        <img src="${url}" alt="Gallery image" loading="lazy">
        <button class="remove-image" onclick="removeImage('${filename}', '${galleryType}', this)">√ó</button>
      `;
      
      gallery.appendChild(imageItem);
    }

    window.removeImage = async (filename, galleryType, button) => {
      try {
        // Remove from storage
        const imageRef = ref(storage, `landing-page/${galleryType}/${filename}`);
        await deleteObject(imageRef);
        
        // Remove from local array
        if (galleryType === 'about') {
          aboutImages = aboutImages.filter(img => img.filename !== filename);
        }
        
        // Remove from DOM
        button.closest('.image-item').remove();
        
        showMessage('Image removed successfully', 'success');
      } catch (error) {
        console.error('Error removing image:', error);
        showMessage('Error removing image: ' + error.message, 'error');
      }
    };

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("You must be logged in.");
        window.location.href = "Login.html";
        return;
      }

      const adminDocRef = doc(db, "admins", user.uid);
      const adminDoc = await getDoc(adminDocRef);

      if (!adminDoc.exists()) {
        alert("Access denied. You are not a system admin.");
        await signOut(auth);
        window.location.href = "Login.html";
        return;
      }

      // Update admin name display
      const adminData = adminDoc.data();
      console.log('Admin data:', adminData); // Debug log
      
      // Try multiple potential field names
      const adminName = adminData.name || 
                       adminData.fullName || 
                       adminData.displayName || 
                       adminData.adminName || 
                       "Admin";
      
      console.log('Resolved admin name:', adminName); // Debug log
      document.getElementById("adminName").textContent = `Welcome, ${adminName}`;

      await loadAllContent();
      await loadAISettings();
    });

    async function loadAllContent() {
      try {
        await loadAboutSection();
        await loadServicesSection();
        await loadPricingSection();
        await updateLastModifiedInfo();
      } catch (error) {
        console.error('Error loading content:', error);
        showMessage('Error loading content: ' + error.message, 'error');
      }
    }

    async function updateLastModifiedInfo() {
      try {
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let lastModified = null;
        
        if (aboutDoc.exists() && aboutDoc.data().lastUpdated) {
          const aboutDate = aboutDoc.data().lastUpdated.toDate();
          if (!lastModified || aboutDate > lastModified) {
            lastModified = aboutDate;
          }
        }
        
        if (servicesDoc.exists() && servicesDoc.data().lastUpdated) {
          const servicesDate = servicesDoc.data().lastUpdated.toDate();
          if (!lastModified || servicesDate > lastModified) {
            lastModified = servicesDate;
          }
        }
        
        const lastModifiedElement = document.getElementById('lastModified');
        if (lastModifiedElement) {
          if (lastModified) {
            lastModifiedElement.textContent = lastModified.toLocaleString();
          } else {
            lastModifiedElement.textContent = 'Never modified (using defaults)';
          }
        }
      } catch (error) {
        console.error('Error updating last modified info:', error);
      }
    }

    async function loadAboutSection() {
      const docRef = doc(db, "landingPage", "about");
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('aboutTitle').value = data.title || "";
        document.getElementById('aboutSubtitle').value = data.subtitle || "";
        document.getElementById('aboutMessage').value = data.message || "";
        
        // Load images
        if (data.images && data.images.length > 0) {
          aboutImages = data.images;
          const gallery = document.getElementById('aboutGallery');
          gallery.innerHTML = '';
          
          data.images.forEach(img => {
            addImageToGallery(img.url, img.filename, 'about');
          });
        }
      } else {
        // Load from existing main document for backward compatibility
        const mainDocRef = doc(db, "landingPage", "main");
        const mainDocSnap = await getDoc(mainDocRef);
        
        if (mainDocSnap.exists()) {
          const data = mainDocSnap.data();
          document.getElementById('aboutTitle').value = data.welcomeText || "";
          document.getElementById('aboutSubtitle').value = data.slogan || "";
          document.getElementById('aboutMessage').value = data.aboutSection || "";
        }
      }
    }

    async function loadServicesSection() {
      const docRef = doc(db, "landingPage", "services");
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('servicesTitle').value = data.title || "";
        document.getElementById('servicesSubtitle').value = data.subtitle || "";
        
        // Load individual services
        if (data.services) {
          data.services.forEach((service, index) => {
            const serviceNum = index + 1;
            document.getElementById(`service${serviceNum}Title`).value = service.title || "";
            document.getElementById(`service${serviceNum}Icon`).value = service.icon || "";
            document.getElementById(`service${serviceNum}Desc`).value = service.description || "";
            document.getElementById(`service${serviceNum}Image`).value = service.imageUrl || "";
          });
        }
      } else {
        // Set default values
        document.getElementById('servicesTitle').value = "Our Services";
        document.getElementById('servicesSubtitle').value = "Comprehensive fitness solutions tailored to your needs";
        
        // Default services
        const defaultServices = [
          { title: "üí™ Personal Training", icon: "üí™", description: "One-on-one training sessions tailored to your specific needs and goals.", imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=200&h=200&fit=crop&crop=face" },
          { title: "üë• Group Fitness Classes", icon: "üë•", description: "Fun and motivating group workouts for all fitness levels.", imageUrl: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=200&h=200&fit=crop&crop=face" },
          { title: "ü•ó Nutrition Coaching", icon: "ü•ó", description: "Personalized nutrition plans to support your fitness journey.", imageUrl: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=200&h=200&fit=crop&crop=center" }
        ];
        
        defaultServices.forEach((service, index) => {
          const serviceNum = index + 1;
          document.getElementById(`service${serviceNum}Title`).value = service.title;
          document.getElementById(`service${serviceNum}Icon`).value = service.icon;
          document.getElementById(`service${serviceNum}Desc`).value = service.description;
          document.getElementById(`service${serviceNum}Image`).value = service.imageUrl;
        });
      }
    }

    // Form submissions
    document.getElementById('aboutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const aboutData = {
          title: document.getElementById('aboutTitle').value.trim(),
          subtitle: document.getElementById('aboutSubtitle').value.trim(),
          message: document.getElementById('aboutMessage').value.trim(),
          images: aboutImages,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        };
        
        await setDoc(doc(db, "landingPage", "about"), aboutData);
        
        // Also update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          welcomeText: aboutData.title,
          slogan: aboutData.subtitle,
          aboutSection: aboutData.message,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        }, { merge: true });
        
        await updateLastModifiedInfo();
        showMessage('‚úÖ About Us section saved successfully!', 'success');
        
        // Add preview link
        setTimeout(() => {
          const previewMsg = document.createElement('div');
          previewMsg.innerHTML = '<a href="index.html" target="_blank" style="color: #007bff; text-decoration: underline;">üîó Click here to preview your changes</a>';
          globalMessage.appendChild(previewMsg);
        }, 1000);
      } catch (error) {
        console.error('Error saving about section:', error);
        showMessage('‚ùå Error saving About Us: ' + error.message, 'error');
      }
    });

    document.getElementById('servicesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const services = [];
        for (let i = 1; i <= 3; i++) {
          services.push({
            title: document.getElementById(`service${i}Title`).value.trim(),
            icon: document.getElementById(`service${i}Icon`).value.trim(),
            description: document.getElementById(`service${i}Desc`).value.trim(),
            imageUrl: document.getElementById(`service${i}Image`).value.trim()
          });
        }
        
        const servicesData = {
          title: document.getElementById('servicesTitle').value.trim(),
          subtitle: document.getElementById('servicesSubtitle').value.trim(),
          services: services,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        };
        
        await setDoc(doc(db, "landingPage", "services"), servicesData);
        
        // Also update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          services: services,
          lastUpdated: new Date(),
          isDefaultTemplate: false
        }, { merge: true });
        
        await updateLastModifiedInfo();
        showMessage('‚úÖ Services section saved successfully!', 'success');
        
        // Add preview link
        setTimeout(() => {
          const previewMsg = document.createElement('div');
          previewMsg.innerHTML = '<a href="index.html" target="_blank" style="color: #007bff; text-decoration: underline;">üîó Click here to preview your changes</a>';
          globalMessage.appendChild(previewMsg);
        }, 1000);
      } catch (error) {
        console.error('Error saving services:', error);
        showMessage('‚ùå Error saving Services: ' + error.message, 'error');
      }
    });

    // Quick actions
    window.previewLandingPage = () => {
      window.open('index.html', '_blank');
    };

    window.exportBackup = async () => {
      try {
        showMessage('Preparing backup...', 'success');
        
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        const mainDoc = await getDoc(doc(db, "landingPage", "main"));
        
        const backup = {
          exportInfo: {
            templateName: "Wise Fitness Landing Page",
            exportDate: new Date().toISOString(),
            version: "1.0",
            adminNote: "Backup created from admin interface"
          },
          content: {
            about: aboutDoc.exists() ? aboutDoc.data() : null,
            services: servicesDoc.exists() ? servicesDoc.data() : null,
            main: mainDoc.exists() ? mainDoc.data() : null
          }
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `wise-fitness-backup-${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showMessage('üì• Backup exported successfully!', 'success');
      } catch (error) {
        showMessage('‚ùå Error exporting backup: ' + error.message, 'error');
      }
    };

    window.validateContent = async () => {
      try {
        showMessage('Validating content...', 'success');
        
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let issues = [];
        
        // Validate About section
        if (aboutDoc.exists()) {
          const aboutData = aboutDoc.data();
          if (!aboutData.title || aboutData.title.trim() === '') {
            issues.push('About section is missing a title');
          }
          if (!aboutData.subtitle || aboutData.subtitle.trim() === '') {
            issues.push('About section is missing a subtitle');
          }
          if (!aboutData.message || aboutData.message.trim() === '') {
            issues.push('About section is missing the main message');
          }
        } else {
          issues.push('About section data not found');
        }
        
        // Validate Services section
        if (servicesDoc.exists()) {
          const servicesData = servicesDoc.data();
          if (!servicesData.title || servicesData.title.trim() === '') {
            issues.push('Services section is missing a title');
          }
          if (!servicesData.services || servicesData.services.length !== 3) {
            issues.push('Services section should have exactly 3 services');
          } else {
            servicesData.services.forEach((service, index) => {
              if (!service.title || service.title.trim() === '') {
                issues.push(`Service ${index + 1} is missing a title`);
              }
              if (!service.description || service.description.trim() === '') {
                issues.push(`Service ${index + 1} is missing a description`);
              }
            });
          }
        } else {
          issues.push('Services section data not found');
        }
        
        if (issues.length === 0) {
          showMessage('‚úÖ All content validation passed! No issues found.', 'success');
        } else {
          showMessage('‚ö†Ô∏è Validation found ' + issues.length + ' issue(s): ' + issues.join(', '), 'error');
        }
        
      } catch (error) {
        showMessage('‚ùå Error during validation: ' + error.message, 'error');
      }
    };

    window.viewAnalytics = async () => {
      try {
        const aboutDoc = await getDoc(doc(db, "landingPage", "about"));
        const servicesDoc = await getDoc(doc(db, "landingPage", "services"));
        
        let analytics = {
          aboutSection: {
            hasCustomImages: false,
            imageCount: 0,
            titleLength: 0,
            messageLength: 0
          },
          servicesSection: {
            servicesCount: 0,
            hasCustomImages: 0,
            avgDescriptionLength: 0
          }
        };
        
        if (aboutDoc.exists()) {
          const aboutData = aboutDoc.data();
          analytics.aboutSection.hasCustomImages = aboutData.images && aboutData.images.length > 0;
          analytics.aboutSection.imageCount = aboutData.images ? aboutData.images.length : 0;
          analytics.aboutSection.titleLength = aboutData.title ? aboutData.title.length : 0;
          analytics.aboutSection.messageLength = aboutData.message ? aboutData.message.length : 0;
        }
        
        if (servicesDoc.exists()) {
          const servicesData = servicesDoc.data();
          analytics.servicesSection.servicesCount = servicesData.services ? servicesData.services.length : 0;
          if (servicesData.services) {
            analytics.servicesSection.hasCustomImages = servicesData.services.filter(s => s.imageUrl).length;
            const totalDescLength = servicesData.services.reduce((sum, s) => sum + (s.description ? s.description.length : 0), 0);
            analytics.servicesSection.avgDescriptionLength = Math.round(totalDescLength / servicesData.services.length);
          }
        }
        
        alert(`üìä Content Analytics:
        
About Section:
‚Ä¢ Title length: ${analytics.aboutSection.titleLength} characters
‚Ä¢ Message length: ${analytics.aboutSection.messageLength} characters  
‚Ä¢ Custom images: ${analytics.aboutSection.imageCount} images
        
Services Section:
‚Ä¢ Total services: ${analytics.servicesSection.servicesCount}
‚Ä¢ Services with images: ${analytics.servicesSection.hasCustomImages}
‚Ä¢ Average description length: ${analytics.servicesSection.avgDescriptionLength} characters`);
        
      } catch (error) {
        showMessage('‚ùå Error loading analytics: ' + error.message, 'error');
      }
    };

    window.resetToDefaults = async () => {
      if (!confirm('‚ö†Ô∏è Are you sure you want to reset all content to the default template?\n\nThis will:\n‚Ä¢ Reset About Us section\n‚Ä¢ Reset Services section\n‚Ä¢ Reset Price Plans to original values (Free: $0, Premium: $10)\n‚Ä¢ Remove all custom images\n\nThis action cannot be undone!')) {
        return;
      }
      
      try {
        showMessage('üîÑ Resetting to default template...', 'success');
        
        // Default About section template
        const defaultAbout = {
          title: "Welcome to Wise Fitness",
          subtitle: "Wise Fitness is more than just a fitness app ‚Äî it's your all-in-one guide to living well.",
          message: "Whether you're training at the gym, exercising at home, or just starting your journey, Wise Fitness supports your goals with the tools and guidance you need to thrive.",
          images: [], // No images in default template
          lastUpdated: new Date(),
          isDefaultTemplate: true
        };
        
        // Default Services section template
        const defaultServices = {
          title: "Our Services",
          subtitle: "Comprehensive fitness solutions tailored to your needs",
          services: [
            { 
              title: "üí™ Personal Training", 
              icon: "üí™", 
              description: "One-on-one training sessions tailored to your specific needs and goals.", 
              imageUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=200&h=200&fit=crop&crop=face" 
            },
            { 
              title: "üë• Group Fitness Classes", 
              icon: "üë•", 
              description: "Fun and motivating group workouts for all fitness levels.", 
              imageUrl: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=200&h=200&fit=crop&crop=face" 
            },
            { 
              title: "ü•ó Nutrition Coaching", 
              icon: "ü•ó", 
              description: "Personalized nutrition plans to support your fitness journey.", 
              imageUrl: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=200&h=200&fit=crop&crop=center" 
            }
          ],
          lastUpdated: new Date(),
          isDefaultTemplate: true
        };
        
        // Default Price Plans section
        const defaultPricing = {
          freePlan: {
            title: "Free",
            price: 0,
            features: "‚úì Access to basic workouts\n‚úì Limited exercise tracking\n‚úì Daily reminders\n‚úó Personalized training\n‚úó Nutrition planning",
            buttonText: "Get Started"
          },
          premiumPlan: {
            title: "Premium",
            price: 10.00,
            features: "‚úì All Free features\n‚úì Personalized fitness plans\n‚úì Full workout library\n‚úì Nutrition and meal guidance\n‚úì Progress tracking and analytics",
            buttonText: "Start Premium"
          },
          lastUpdated: new Date(),
          isDefaultTemplate: true
        };
        
        // Save all default data to Firestore
        await Promise.all([
          setDoc(doc(db, "landingPage", "about"), defaultAbout),
          setDoc(doc(db, "landingPage", "services"), defaultServices),
          setDoc(doc(db, "landingPage", "pricing"), defaultPricing)
        ]);
        
        // Update main document for backward compatibility
        await setDoc(doc(db, "landingPage", "main"), {
          welcomeText: defaultAbout.title,
          slogan: defaultAbout.subtitle,
          aboutSection: defaultAbout.message,
          services: defaultServices.services,
          lastUpdated: new Date(),
          isDefaultTemplate: true
        }, { merge: true });
        
        // Clear any uploaded images from storage and local arrays
        if (aboutImages.length > 0) {
          for (const image of aboutImages) {
            try {
              await deleteObject(image.ref);
            } catch (error) {
              console.warn('Error deleting image:', error);
            }
          }
        }
        aboutImages = [];
        document.getElementById('aboutGallery').innerHTML = '';
        
        // Reload content to reflect reset
        await loadAllContent();
        
        showMessage('‚úÖ Content successfully reset to default template! All sections including price plans have been restored to their original state.', 'success');
        
        // Add preview link
        setTimeout(() => {
          const previewMsg = document.createElement('div');
          previewMsg.innerHTML = '<a href="index.html" target="_blank" style="color: #007bff; text-decoration: underline;">üîó Click here to preview the reset changes</a>';
          globalMessage.appendChild(previewMsg);
        }, 1000);
        
      } catch (error) {
        console.error('Error resetting to defaults:', error);
        showMessage('‚ùå Error resetting to defaults: ' + error.message, 'error');
      }
    };

    // Menu functions
    window.sendPasswordReset = () => {
      const user = auth.currentUser;
      if (!user || !user.email) {
        alert("No user logged in.");
        return;
      }
      if (confirm(`Send password reset to ${user.email}?`)) {
        sendPasswordResetEmail(auth, user.email)
          .then(() => alert("Password reset email sent!"))
          .catch(err => alert("Error: " + err.message));
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        window.location.href = "Login.html";
      } catch (error) {
        alert("Logout failed: " + error.message);
      }
    };

    window.resetPassword = () => {
      const user = auth.currentUser;
      if (!user || !user.email) {
        alert("No user logged in.");
        return;
      }
      if (confirm(`Send password reset to ${user.email}?`)) {
        sendPasswordResetEmail(auth, user.email)
          .then(() => alert("Password reset email sent!"))
          .catch(err => alert("Error: " + err.message));
      }
    };

    // Drag and drop for file uploads
    ['aboutImages'].forEach(inputId => {
      const uploadArea = document.querySelector(`#${inputId}`).closest('.upload-area');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        document.getElementById(inputId).files = files;
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        document.getElementById(inputId).dispatchEvent(event);
      });
    });

    // PRICING MANAGEMENT FUNCTIONS
    
    // Price validation function
    window.validatePrice = (input) => {
      let value = parseFloat(input.value);
      
      // Check for negative values
      if (value < 0) {
        input.value = 0;
        showMessage('‚ùå Price cannot be negative. Value reset to 0.', 'error');
        return;
      }
      
      // Check for maximum value
      if (value > 9999.99) {
        input.value = 9999.99;
        showMessage('‚ùå Price cannot exceed $9999.99. Value capped at maximum.', 'error');
        return;
      }
      
      // Ensure proper decimal places (max 2)
      if (input.value.includes('.') && input.value.split('.')[1].length > 2) {
        input.value = value.toFixed(2);
      }
    };
    
    // Word count tracking for features
    document.getElementById('freePlanFeatures').addEventListener('input', function() {
      const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
      document.getElementById('freeFeaturesCount').textContent = wordCount;
      if (wordCount > 700) {
        document.getElementById('freeFeaturesCount').style.color = '#dc3545';
      } else {
        document.getElementById('freeFeaturesCount').style.color = 'var(--text-muted)';
      }
    });
    
    document.getElementById('premiumPlanFeatures').addEventListener('input', function() {
      const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
      document.getElementById('premiumFeaturesCount').textContent = wordCount;
      if (wordCount > 700) {
        document.getElementById('premiumFeaturesCount').style.color = '#dc3545';
      } else {
        document.getElementById('premiumFeaturesCount').style.color = 'var(--text-muted)';
      }
    });

    // Load pricing data
    async function loadPricingSection() {
      try {
        const user = auth.currentUser;
        if (!user) return;

        // Try to load from the same collection structure as other sections
        const docRef = doc(db, 'landingPage', 'pricing');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          // Load Free plan data
          if (data.freePlan) {
            document.getElementById('freePlanTitle').value = data.freePlan.title || 'Free';
            document.getElementById('freePlanPrice').value = data.freePlan.price || 0;
            document.getElementById('freePlanFeatures').value = data.freePlan.features || '‚úì Access to basic workouts\n‚úì Limited exercise tracking\n‚úì Daily reminders\n‚úó Personalized training\n‚úó Nutrition planning';
            document.getElementById('freePlanButton').value = data.freePlan.buttonText || 'Get Started';
          }
          
          // Load Premium plan data
          if (data.premiumPlan) {
            document.getElementById('premiumPlanTitle').value = data.premiumPlan.title || 'Premium';
            document.getElementById('premiumPlanPrice').value = data.premiumPlan.price || 10.00;
            document.getElementById('premiumPlanFeatures').value = data.premiumPlan.features || '‚úì All Free features\n‚úì Personalized fitness plans\n‚úì Full workout library\n‚úì Nutrition and meal guidance\n‚úì Progress tracking and analytics';
            document.getElementById('premiumPlanButton').value = data.premiumPlan.buttonText || 'Start Premium';
          }
        } else {
          // Set default values if no document exists
          console.log('No pricing document found, using defaults');
        }
        
        // Update word counts
        document.getElementById('freePlanFeatures').dispatchEvent(new Event('input'));
        document.getElementById('premiumPlanFeatures').dispatchEvent(new Event('input'));
        
      } catch (error) {
        console.error('Error loading pricing data:', error);
        // Don't show error message for loading, just use defaults
        console.log('Using default pricing values due to error:', error.message);
      }
    }

    // Save pricing data
    document.getElementById('pricingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        const user = auth.currentUser;
        if (!user) {
          showMessage('‚ùå Please log in to save pricing data', 'error');
          return;
        }

        // Validate prices
        const freePrice = parseFloat(document.getElementById('freePlanPrice').value) || 0;
        const premiumPrice = parseFloat(document.getElementById('premiumPlanPrice').value) || 0;
        
        if (freePrice < 0) {
          showMessage('‚ùå Free plan price cannot be negative.', 'error');
          document.getElementById('freePlanPrice').value = 0;
          return;
        }
        
        if (premiumPrice < 0) {
          showMessage('‚ùå Premium plan price cannot be negative.', 'error');
          document.getElementById('premiumPlanPrice').value = 0;
          return;
        }
        
        if (freePrice > 9999.99 || premiumPrice > 9999.99) {
          showMessage('‚ùå Price cannot exceed $9999.99.', 'error');
          return;
        }

        // Validate word counts
        const freeWordCount = document.getElementById('freePlanFeatures').value.trim().split(/\s+/).filter(word => word.length > 0).length;
        const premiumWordCount = document.getElementById('premiumPlanFeatures').value.trim().split(/\s+/).filter(word => word.length > 0).length;
        
        if (freeWordCount > 700) {
          showMessage('‚ùå Free plan features exceed 700 words. Please shorten the content.', 'error');
          return;
        }
        
        if (premiumWordCount > 700) {
          showMessage('‚ùå Premium plan features exceed 700 words. Please shorten the content.', 'error');
          return;
        }

        // Prepare pricing data with proper float formatting
        const pricingData = {
          freePlan: {
            title: document.getElementById('freePlanTitle').value.trim() || 'Free',
            price: parseFloat(freePrice.toFixed(2)), // Ensure 2 decimal places
            features: document.getElementById('freePlanFeatures').value.trim() || '',
            buttonText: document.getElementById('freePlanButton').value.trim() || 'Get Started'
          },
          premiumPlan: {
            title: document.getElementById('premiumPlanTitle').value.trim() || 'Premium',
            price: parseFloat(premiumPrice.toFixed(2)), // Ensure 2 decimal places
            features: document.getElementById('premiumPlanFeatures').value.trim() || '',
            buttonText: document.getElementById('premiumPlanButton').value.trim() || 'Start Premium'
          },
          lastUpdated: new Date(),
          isDefaultTemplate: false
        };

        // Save to the same collection structure as other sections
        const docRef = doc(db, 'landingPage', 'pricing');
        await setDoc(docRef, pricingData, { merge: true });
        
        await updateLastModifiedInfo();
        
        showMessage('‚úÖ Price plans saved successfully!', 'success');
      } catch (error) {
        console.error('Error saving pricing data:', error);
        
        // Handle specific Firebase errors
        if (error.code === 'permission-denied') {
          showMessage('‚ùå Access denied. You do not have permission to save pricing data. Please contact your administrator.', 'error');
        } else if (error.code === 'unauthenticated') {
          showMessage('‚ùå Authentication required. Please log out and log back in.', 'error');
        } else if (error.code === 'unavailable') {
          showMessage('‚ùå Service temporarily unavailable. Please try again in a moment.', 'error');
        } else {
          showMessage('‚ùå Error saving pricing data: ' + error.message, 'error');
        }
      }
    });

    // TESTIMONIALS MANAGEMENT FUNCTIONS - AI-Enhanced Version
    
    // Global variables for testimonials
    let allTestimonialsData = [];
    let filteredTestimonialsData = [];
    let currentPage = 1;
    const itemsPerPage = 15;
    let isAiAnalyzing = false;
    
    // AI Configuration - SECURITY: Use environment variable or configure in admin settings
    const OPENAI_API_KEY = 'your-openai-api-key-here'; // Configure this securely via environment variables
    const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
    
    // Test OpenAI API connection
    window.testOpenAI = async function() {
      try {
        showMessage('üß™ Testing OpenAI API connection...', 'success');
        
        // Test with different scenarios
        const testCases = [
          { feedback: 'This is a great app! I love using it every day.', rating: 5 },
          { feedback: 'This app is terrible and crashes all the time.', rating: 1 },
          { feedback: 'The app is okay, but needs improvement.', rating: 3 }
        ];
        
        for (const testCase of testCases) {
          const analysis = await callOpenAIWithFallback(testCase.feedback, testCase.rating);
        }
        
        showMessage(`‚úÖ API Test Successful! All test cases completed.`, 'success');
        return true;
        
      } catch (error) {
        console.error('API Test Failed:', error);
        showMessage(`‚ùå API Test Failed: ${error.message}`, 'error');
        
        // Check common issues
        if (error.message.includes('401')) {
          showMessage('üîë Error 401: Invalid API key. Please check your OpenAI API key.', 'error');
        } else if (error.message.includes('429')) {
          showMessage('‚è≥ Error 429: Rate limit exceeded. Please wait and try again.', 'error');
        } else if (error.message.includes('CORS')) {
          showMessage('üåê CORS Error: This might be a browser security issue. Try using this from a server environment.', 'error');
        }
        
        return false;
      }
    };
    
    // Update dashboard statistics
    window.updateDashboardStats = function() {
      const dashboard = document.getElementById('testimonials-dashboard');
      const countElement = document.getElementById('testimonial-count');
      
      if (!allTestimonialsData || allTestimonialsData.length === 0) {
        dashboard.style.display = 'none';
        countElement.textContent = 'No testimonials loaded';
        return;
      }
      
      // Calculate dashboard statistics
      const stats = {
        total: allTestimonialsData.length,
        business: allTestimonialsData.filter(t => t.userMembershipType === 'business').length,
        basic: allTestimonialsData.filter(t => t.userMembershipType === 'basic').length,
        premium: allTestimonialsData.filter(t => t.userMembershipType === 'premium').length
      };
      
      // Update dashboard - User types
      document.getElementById('total-reviews').textContent = stats.total;
      document.getElementById('business-reviews').textContent = stats.business;
      document.getElementById('basic-reviews').textContent = stats.basic;
      document.getElementById('premium-reviews').textContent = stats.premium;
      
      dashboard.style.display = 'block';
      
      // Update count with breakdown
      countElement.textContent = `Total: ${stats.total} reviews (${stats.business} business, ${stats.basic} basic, ${stats.premium} premium)`;
    };
    
    // Load testimonials for dashboard only
    window.loadTestimonials = async function() {
      const countElement = document.getElementById('testimonial-count');
      const dashboard = document.getElementById('testimonials-dashboard');
      
      // Show loading state
      countElement.textContent = 'Loading...';
      dashboard.style.display = 'none';
      
      try {
        // Fetch all collections in parallel
        const [businessTestimonials, regularTestimonials, businessUsers, regularUsers] = await Promise.all([
          getDocs(collection(db, 'businessUserTestimonial')),
          getDocs(collection(db, 'testimonial')),
          getDocs(collection(db, 'businessUsers')),
          getDocs(collection(db, 'users'))
        ]);
        
        // Create user lookup maps
        const businessUserMap = new Map();
        businessUsers.forEach(doc => {
          businessUserMap.set(doc.id, doc.data());
        });
        
        const regularUserMap = new Map();
        regularUsers.forEach(doc => {
          regularUserMap.set(doc.id, doc.data());
        });
        
        // Combine testimonial results with user data
        allTestimonialsData = [];
        
        // Process business testimonials
        businessTestimonials.forEach(doc => {
          const data = doc.data();
          const userData = businessUserMap.get(data.userId || doc.id);
          
          // EXCEPTION: Skip specific user who should be in premium category
          if (data.userId === '5bP0koGL6cSqNPQfpDH5uJUMSqH2') {
            return; // Skip this iteration
          }
          
          allTestimonialsData.push({
            id: doc.id,
            ...data,
            source: 'business',
            userMembershipType: 'business', // Force business type for all business testimonials
            userName: userData?.businessName || userData?.fullName || 'Unknown Business',
            userEmail: userData?.email || 'Unknown',
            // Initialize AI analysis fields
            aiSentiment: data.aiSentiment || null,
            aiScore: data.aiScore || null,
            aiFlags: data.aiFlags || []
          });
        });
        
        // Process regular testimonials
        regularTestimonials.forEach(doc => {
          const data = doc.data();
          
          // Try multiple ways to find user data
          let userData = null;
          let userId = data.userId || doc.id;
          
          // First try with testimonial's userId
          if (data.userId) {
            userData = regularUserMap.get(data.userId);
          }
          
          // If not found and different from doc.id, try with doc.id
          if (!userData && data.userId !== doc.id) {
            userData = regularUserMap.get(doc.id);
            userId = doc.id;
          }
          
          // Enhanced membership type detection
          let membershipType = 'basic'; // Default to basic
          
          // EXCEPTION CASE: Handle specific user with inconsistent data
          if (userId === '5bP0koGL6cSqNPQfpDH5uJUMSqH2') {
            membershipType = 'premium';
          } else {
            // Check multiple sources for membership type
            if (userData) {
              // Check various possible field names for membership type
              membershipType = userData.membershipType || 
                             userData.membership || 
                             userData.userType || 
                             userData.accountType || 
                             'basic';
            }
            
            // Also check if membership type is directly in testimonial data
            if (data.membershipType) {
              membershipType = data.membershipType;
            }
            if (data.userMembershipType) {
              membershipType = data.userMembershipType;
            }
            
            // Exception handling for legacy/inconsistent data
            // Handle "normal" userType from old data structure
            if (data.userType === 'normal' || membershipType === 'normal') {
              membershipType = 'basic'; // Treat "normal" as "basic" user
            }
          }
          
          // Ensure this testimonial is NOT marked as business
          if (membershipType === 'business') {
            console.warn(`Warning: Regular testimonial ${doc.id} has business membership type, converting to basic`);
            membershipType = 'basic';
          }
          
          allTestimonialsData.push({
            id: doc.id,
            ...data,
            source: 'regular',
            userMembershipType: membershipType,
            userName: userData?.fullName || userData?.username || 'Unknown User',
            userEmail: userData?.email || 'Unknown',
            // Initialize AI analysis fields
            aiSentiment: data.aiSentiment || null,
            aiScore: data.aiScore || null,
            aiFlags: data.aiFlags || []
          });
        });
        
        // Calculate dashboard statistics
        const stats = {
          total: allTestimonialsData.length,
          business: allTestimonialsData.filter(t => t.userMembershipType === 'business').length,
          basic: allTestimonialsData.filter(t => t.userMembershipType === 'basic').length,
          premium: allTestimonialsData.filter(t => t.userMembershipType === 'premium').length
        };
        
        // Check for testimonials with unexpected membership types
        const unknownTypes = allTestimonialsData.filter(t => 
          !['business', 'basic', 'premium', 'freemium', 'free', 'normal'].includes(t.userMembershipType)
        );
        if (unknownTypes.length > 0) {
          console.warn('Testimonials with unknown membership types:', unknownTypes.map(t => ({
            id: t.id,
            userName: t.userName,
            membershipType: t.userMembershipType
          })));
        }
        
        // Update dashboard - User types
        document.getElementById('total-reviews').textContent = stats.total;
        document.getElementById('business-reviews').textContent = stats.business;
        document.getElementById('basic-reviews').textContent = stats.basic;
        document.getElementById('premium-reviews').textContent = stats.premium;
        
        dashboard.style.display = 'block';
        
        // Update count with breakdown
        countElement.textContent = `Total: ${stats.total} reviews (${stats.business} business, ${stats.basic} basic, ${stats.premium} premium)`;
        
      } catch (error) {
        console.error('Error loading testimonials:', error);
        countElement.textContent = 'Error loading data';
        dashboard.style.display = 'none';
        showMessage('‚ùå Error loading testimonials: ' + error.message, 'error');
      }
    };
    
    // Open testimonials modal
    window.openTestimonialsModal = async function() {
      const modal = document.getElementById('testimonials-modal');
      const modalContent = document.getElementById('modal-testimonials-content');
      
      modal.style.display = 'block';
      modalContent.innerHTML = '<p class="loading-text">Loading testimonials...</p>';
      
      // Load testimonials if not already loaded
      if (allTestimonialsData.length === 0) {
        await loadTestimonials();
      }
      
      // Initialize filtered data
      filteredTestimonialsData = [...allTestimonialsData];
      currentPage = 1;
      
      // Sort by submission date (most recent first)
      filteredTestimonialsData.sort((a, b) => {
        const dateA = a.submittedAt || a.timestamp || 0;
        const dateB = b.submittedAt || b.timestamp || 0;
        return new Date(dateB) - new Date(dateA);
      });
      
      renderTestimonialsTable();
    };
    
    // Close testimonials modal
    window.closeTestimonialsModal = function() {
      document.getElementById('testimonials-modal').style.display = 'none';
    };
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('testimonials-modal');
      if (event.target === modal) {
        closeTestimonialsModal();
      }
    };
    
    // Filter testimonials with strict priority order: Membership ‚Üí Rating ‚Üí AI Sentiment
    window.filterTestimonials = function() {
      const membershipFilter = document.getElementById('filter-membership').value;
      const sentimentFilter = document.getElementById('filter-sentiment').value;
      const ratingFilter = document.getElementById('filter-rating').value;
      const searchFilter = document.getElementById('filter-search').value.toLowerCase();
      
      // ALWAYS start fresh from all testimonials
      filteredTestimonialsData = [...allTestimonialsData];
      
      // PRIORITY 1: Membership filter (HIGHEST PRIORITY - MUST BE EXACT MATCH)
      if (membershipFilter && membershipFilter !== '') {
        filteredTestimonialsData = filteredTestimonialsData.filter(testimonial => {
          const userType = testimonial.userMembershipType;
          return userType === membershipFilter;
        });
        
        // If membership filter results in 0 testimonials, stop here
        if (filteredTestimonialsData.length === 0) {
          currentPage = 1;
          renderTestimonialsTable();
          return;
        }
      }
      
      // PRIORITY 2: Rating filter (SECOND PRIORITY)
      if (ratingFilter && ratingFilter !== '' && filteredTestimonialsData.length > 0) {
        filteredTestimonialsData = filteredTestimonialsData.filter(testimonial => {
          const rating = testimonial.rating || 0;
          let isMatch = false;
          
          if (ratingFilter === 'low') {
            // 3 stars and below
            isMatch = rating <= 3;
          } else if (ratingFilter === '4') {
            isMatch = rating === 4;
          } else if (ratingFilter === '5') {
            isMatch = rating === 5;
          }
          
          return isMatch;
        });
      }
      
      // PRIORITY 3: AI Sentiment filter (THIRD PRIORITY)
      if (sentimentFilter && sentimentFilter !== '' && filteredTestimonialsData.length > 0) {
        filteredTestimonialsData = filteredTestimonialsData.filter(testimonial => {
          const sentiment = testimonial.aiSentiment;
          return sentiment === sentimentFilter;
        });
      }
      
      // PRIORITY 4: Search filter (LOWEST PRIORITY)
      if (searchFilter && searchFilter.trim() !== '' && filteredTestimonialsData.length > 0) {
        filteredTestimonialsData = filteredTestimonialsData.filter(testimonial => {
          const searchText = `${testimonial.feedback || ''} ${testimonial.userName || ''} ${testimonial.userEmail || ''}`.toLowerCase();
          return searchText.includes(searchFilter);
        });
      }
      
      // Reset to page 1 and render
      currentPage = 1;
      renderTestimonialsTable();
    };
    
    // Clear all filters and show all testimonials
    window.clearAllFilters = function() {
      // Reset all filter controls
      document.getElementById('filter-membership').value = '';
      document.getElementById('filter-rating').value = '';
      document.getElementById('filter-sentiment').value = '';
      document.getElementById('filter-search').value = '';
      
      // Reset filtered data to show all testimonials
      filteredTestimonialsData = [...allTestimonialsData];
      currentPage = 1;
      
      renderTestimonialsTable();
    };
    
    // Render testimonials table with pagination
    function renderTestimonialsTable() {
      const modalContent = document.getElementById('modal-testimonials-content');
      const pagination = document.getElementById('testimonials-pagination');
      
      if (filteredTestimonialsData.length === 0) {
        modalContent.innerHTML = '<p class="loading-text">No testimonials match the current filters.</p>';
        pagination.style.display = 'none';
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredTestimonialsData.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = filteredTestimonialsData.slice(startIndex, endIndex);
      
      // Generate table HTML
      const tableHTML = `
        <table class="testimonials-table">
          <thead>
            <tr>
              <th>User Info</th>
              <th>Membership</th>
              <th>Rating</th>
              <th>AI Analysis</th>
              <th>Feedback</th>
              <th>Submitted</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${pageData.map(testimonial => `
              <tr>
                <td>
                  <div style="font-weight: 600; margin-bottom: 2px;">${testimonial.userName}</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">${testimonial.userEmail}</div>
                  <div style="font-size: 0.75rem; font-family: monospace; color: var(--text-muted);">${testimonial.userId || testimonial.id}</div>
                </td>
                <td>
                  <span class="user-type-badge ${getMembershipBadgeClass(testimonial.userMembershipType)}">
                    ${getMembershipDisplayName(testimonial.userMembershipType)}
                  </span>
                </td>
                <td>
                  <span class="rating-stars">${'‚òÖ'.repeat(testimonial.rating || 0)}${'‚òÜ'.repeat(5 - (testimonial.rating || 0))}</span>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">(${testimonial.rating || 0}/5)</div>
                </td>
                <td>
                  ${renderAiAnalysis(testimonial)}
                </td>
                <td>
                  <div class="feedback-text">
                    ${renderFeedbackPreview(testimonial.feedback || 'No feedback')}
                  </div>
                </td>
                <td style="font-size: 0.85rem;">
                  ${formatDate(testimonial.submittedAt || testimonial.timestamp)}
                </td>
                <td>
                  <span style="color: ${testimonial.isCompleted ? 'var(--success)' : 'var(--warning)'};">
                    ${testimonial.isCompleted ? '‚úÖ Completed' : '‚è≥ Pending'}
                  </span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      modalContent.innerHTML = tableHTML;
      
      // Update pagination
      if (totalPages > 1) {
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages} (${filteredTestimonialsData.length} items)`;
        pagination.style.display = 'flex';
        
        // Update pagination buttons
        const prevBtn = pagination.querySelector('button:first-child');
        const nextBtn = pagination.querySelector('button:last-child');
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
      } else {
        pagination.style.display = 'none';
      }
    }
    
    // Change page
    window.changePage = function(direction) {
      const totalPages = Math.ceil(filteredTestimonialsData.length / itemsPerPage);
      
      if (direction === 1 && currentPage < totalPages) {
        currentPage++;
      } else if (direction === -1 && currentPage > 1) {
        currentPage--;
      }
      
      renderTestimonialsTable();
    };
    
    // Render AI analysis with better validation
    function renderAiAnalysis(testimonial) {
      // Don't show analyze button if no feedback exists
      if (!testimonial.feedback || testimonial.feedback.trim() === '' || testimonial.feedback === 'No feedback') {
        return `
          <div style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">
            No feedback to analyze
          </div>
        `;
      }
      
      if (!testimonial.aiSentiment) {
        return `
          <button onclick="analyzeSingleTestimonial('${testimonial.id}')" 
                  style="background: #ffc107; color: #212529; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
            ü§ñ Analyze
          </button>
        `;
      }
      
      const sentimentClass = `sentiment-${testimonial.aiSentiment}`;
      const score = testimonial.aiScore ? `(${Math.round(testimonial.aiScore * 100)}%)` : '';
      
      // Check for rating-sentiment correlation
      const rating = testimonial.rating || 0;
      let correlationIcon = '';
      let correlationTitle = '';
      
      if (rating >= 4 && testimonial.aiSentiment === 'positive') {
        correlationIcon = '‚úÖ';
        correlationTitle = 'Good correlation: High rating + Positive sentiment';
      } else if (rating <= 3 && (testimonial.aiSentiment === 'negative' || testimonial.aiSentiment === 'neutral')) {
        correlationIcon = '‚úÖ';
        correlationTitle = 'Good correlation: Low rating + Negative/Neutral sentiment';
      } else if (rating >= 4 && (testimonial.aiSentiment === 'negative' || testimonial.aiSentiment === 'neutral')) {
        correlationIcon = '‚ö†Ô∏è';
        correlationTitle = 'Warning: High rating but negative/neutral sentiment - possible sarcasm or fake review';
      } else if (rating <= 3 && testimonial.aiSentiment === 'positive') {
        correlationIcon = '‚ö†Ô∏è';
        correlationTitle = 'Warning: Low rating but positive sentiment - inconsistent review';
      } else if (testimonial.aiSentiment === 'spam') {
        correlationIcon = 'üö´';
        correlationTitle = 'Spam detected';
      } else if (testimonial.aiSentiment === 'inappropriate') {
        correlationIcon = 'ÔøΩ';
        correlationTitle = 'Inappropriate content detected';
      } else {
        correlationIcon = 'üîç';
        correlationTitle = 'Neutral analysis';
      }
      
      return `
        <div>
          <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
            <span class="ai-sentiment-badge ${sentimentClass}">
              ${testimonial.aiSentiment.toUpperCase()}
            </span>
            <span title="${correlationTitle}" style="font-size: 0.8rem; cursor: help;">${correlationIcon}</span>
          </div>
          <div class="ai-score">${score}</div>
          ${testimonial.aiFlags && testimonial.aiFlags.length > 0 ? 
            `<div style="font-size: 0.7rem; color: #dc3545; margin-top: 2px;">‚ö†Ô∏è ${testimonial.aiFlags.join(', ')}</div>` : ''}
        </div>
      `;
    }
    
    // Render feedback preview with expand functionality
    function renderFeedbackPreview(feedback) {
      if (!feedback || feedback.length <= 100) {
        return `<div class="feedback-full">${feedback}</div>`;
      }
      
      const preview = feedback.substring(0, 100) + '...';
      const fullId = 'full_' + Math.random().toString(36).substr(2, 9);
      const previewId = 'preview_' + Math.random().toString(36).substr(2, 9);
      
      return `
        <div id="${previewId}" class="feedback-preview" onclick="toggleFeedback('${previewId}', '${fullId}')" title="Click to expand">
          ${preview}
        </div>
        <div id="${fullId}" class="feedback-full" style="display: none;" onclick="toggleFeedback('${previewId}', '${fullId}')" title="Click to collapse">
          ${feedback}
        </div>
      `;
    }
    
    // Toggle feedback display
    window.toggleFeedback = function(previewId, fullId) {
      const preview = document.getElementById(previewId);
      const full = document.getElementById(fullId);
      
      if (preview.style.display === 'none') {
        preview.style.display = 'block';
        full.style.display = 'none';
      } else {
        preview.style.display = 'none';
        full.style.display = 'block';
      }
    };
    
    // Refresh testimonials data
    window.refreshTestimonials = async function() {
      try {
        showMessage('üîÑ Refreshing testimonials...', 'success');
        await loadTestimonials(); // Load fresh data from Firestore
        
        // If modal is open, refresh the table view
        const modal = document.getElementById('testimonials-modal');
        if (modal.style.display === 'block') {
          filteredTestimonialsData = [...allTestimonialsData];
          renderTestimonialsTable();
        }
        
        updateDashboardStats();
        showMessage('‚úÖ Testimonials refreshed successfully!', 'success');
      } catch (error) {
        console.error('Error refreshing testimonials:', error);
        showMessage('‚ùå Error refreshing testimonials: ' + error.message, 'error');
      }
    };

    // AI Analysis Functions
    window.analyzeAllTestimonials = async function() {
      if (isAiAnalyzing) return;
      
      if (!OPENAI_API_KEY || OPENAI_API_KEY === 'your-openai-api-key-here') {
        showMessage('‚ùå OpenAI API key not configured. Please add your API key to enable AI analysis.', 'error');
        return;
      }
      
      const button = document.getElementById('ai-analyze-all');
      const originalText = button.textContent;
      
      try {
        isAiAnalyzing = true;
        button.disabled = true;
        
        // First refresh the data
        button.textContent = 'üîÑ Refreshing data...';
        await refreshTestimonials();
        
        button.textContent = 'ü§ñ Analyzing...';
        
        const unanalyzedTestimonials = allTestimonialsData.filter(t => 
          !t.aiSentiment && 
          t.feedback && 
          t.feedback.trim() !== '' && 
          t.feedback !== 'No feedback' &&
          t.feedback.trim().length >= 3
        );
        
        if (unanalyzedTestimonials.length === 0) {
          showMessage('‚úÖ All testimonials with feedback have already been analyzed!', 'success');
          return;
        }
        
        showMessage(`ü§ñ Starting AI analysis of ${unanalyzedTestimonials.length} testimonials...`, 'success');
        
        // Process in batches to avoid rate limits
        const batchSize = 5;
        for (let i = 0; i < unanalyzedTestimonials.length; i += batchSize) {
          const batch = unanalyzedTestimonials.slice(i, i + batchSize);
          
          button.textContent = `ü§ñ Analyzing... (${i + 1}-${Math.min(i + batchSize, unanalyzedTestimonials.length)}/${unanalyzedTestimonials.length})`;
          
          await Promise.all(batch.map(testimonial => analyzeSingleTestimonial(testimonial.id, false)));
          
          // Small delay between batches
          if (i + batchSize < unanalyzedTestimonials.length) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
        
        showMessage('‚úÖ AI analysis completed for all testimonials!', 'success');
        renderTestimonialsTable();
        updateDashboardStats();
        
      } catch (error) {
        console.error('Error in batch AI analysis:', error);
        showMessage('‚ùå Error during AI analysis: ' + error.message, 'error');
      } finally {
        isAiAnalyzing = false;
        button.disabled = false;
        button.textContent = originalText;
      }
    };
    
    window.analyzeSingleTestimonial = async function(testimonialId, showIndividualMessage = true) {
      try {
        const testimonial = allTestimonialsData.find(t => t.id === testimonialId);
        if (!testimonial) {
          if (showIndividualMessage) {
            showMessage('‚ùå Testimonial not found', 'error');
          }
          return;
        }
        
        // Check if feedback exists and is meaningful
        if (!testimonial.feedback || testimonial.feedback.trim() === '' || testimonial.feedback === 'No feedback') {
          if (showIndividualMessage) {
            showMessage('‚ùå No meaningful feedback found for this testimonial. Cannot analyze empty content.', 'error');
          }
          return;
        }
        
        // Check if feedback is too short (less than 3 characters)
        if (testimonial.feedback.trim().length < 3) {
          if (showIndividualMessage) {
            showMessage('‚ùå Feedback too short to analyze meaningfully.', 'error');
          }
          return;
        }
        
        if (!OPENAI_API_KEY || OPENAI_API_KEY === 'your-openai-api-key-here') {
          if (showIndividualMessage) {
            showMessage('‚ùå OpenAI API key not configured', 'error');
          }
          return;
        }
        
        if (showIndividualMessage) {
          showMessage(`ü§ñ Analyzing feedback: "${testimonial.feedback.substring(0, 50)}..."`, 'success');
        }
        
        const analysis = await callOpenAIWithFallback(testimonial.feedback, testimonial.rating);
        
        // Update testimonial with AI analysis
        testimonial.aiSentiment = analysis.sentiment;
        testimonial.aiScore = analysis.confidence;
        testimonial.aiFlags = analysis.flags;
        
        // Save to Firestore
        const collection_name = testimonial.source === 'business' ? 'businessUserTestimonial' : 'testimonial';
        const docRef = doc(db, collection_name, testimonialId);
        
        await updateDoc(docRef, {
          aiSentiment: analysis.sentiment,
          aiScore: analysis.confidence,
          aiFlags: analysis.flags,
          aiAnalyzedAt: new Date()
        });
        
        if (showIndividualMessage) {
          const correlationNote = getCorrelationNote(testimonial.rating, analysis.sentiment);
          showMessage(`‚úÖ AI analysis completed: ${analysis.sentiment} (${Math.round(analysis.confidence * 100)}% confidence)${correlationNote}`, 'success');
          renderTestimonialsTable();
        }
        
      } catch (error) {
        console.error('Error analyzing testimonial:', error);
        if (showIndividualMessage) {
          showMessage('‚ùå Error during AI analysis: ' + error.message, 'error');
        }
      }
    };
    
    // Helper function to provide correlation insights
    function getCorrelationNote(rating, sentiment) {
      if (!rating) return '';
      
      if (rating >= 4 && sentiment === 'positive') {
        return ' ‚úÖ (Good correlation)';
      } else if (rating <= 3 && (sentiment === 'negative' || sentiment === 'neutral')) {
        return ' ‚úÖ (Good correlation)';
      } else if (rating >= 4 && (sentiment === 'negative' || sentiment === 'neutral')) {
        return ' ‚ö†Ô∏è (High rating but negative sentiment - review for authenticity)';
      } else if (rating <= 3 && sentiment === 'positive') {
        return ' ‚ö†Ô∏è (Low rating but positive sentiment - possible mixed review)';
      }
      return '';
    }
    
    // Call OpenAI API for sentiment analysis
    async function callOpenAI(feedback, starRating = null) {
      const ratingContext = starRating ? `\nStar Rating: ${starRating}/5 stars` : '';
      
      const prompt = `Analyze the following customer testimonial and provide:
1. Sentiment: positive, negative, neutral, spam, or inappropriate
2. Confidence score (0-1)
3. Any flags for concerns (spam, inappropriate language, fake review, rating-text mismatch, etc.)

Testimonial: "${feedback}"${ratingContext}

Guidelines:
- 5 stars usually indicates positive sentiment
- 4 stars usually indicates positive sentiment
- 3 stars and below usually indicates negative or neutral sentiment
- Flag if star rating doesn't match the text sentiment
- Consider both text content and star rating for final sentiment

Respond in JSON format:
{
  "sentiment": "positive|negative|neutral|spam|inappropriate",
  "confidence": 0.95,
  "flags": ["spam", "inappropriate", "rating_text_mismatch"] // empty array if no flags
}`;
      
      try {
        const response = await fetch(OPENAI_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              {
                role: 'system',
                content: 'You are an expert at analyzing customer feedback sentiment and detecting spam or inappropriate content. Always respond with valid JSON.'
              },
              {
                role: 'user',
                content: prompt
              }
            ],
            max_tokens: 150,
            temperature: 0.1
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('OpenAI API Error Response:', errorText);
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}. Details: ${errorText}`);
        }
        
        const data = await response.json();
        const aiResponse = data.choices[0].message.content.trim();
        
        try {
          const parsedResponse = JSON.parse(aiResponse);
          return parsedResponse;
        } catch (parseError) {
          console.error('Error parsing AI response:', aiResponse);
          console.error('Parse error:', parseError);
          
          // Try to extract sentiment manually if JSON parsing fails
          const fallbackSentiment = extractSentimentFallback(aiResponse);
          
          return {
            sentiment: fallbackSentiment,
            confidence: 0.5,
            flags: ['parsing_error']
          };
        }
        
      } catch (networkError) {
        console.error('Network/API Error:', networkError);
        throw new Error(`Failed to call OpenAI API: ${networkError.message}`);
      }
    }
    
    // Enhanced rule-based sentiment analysis that considers star ratings
    function analyzeWithRules(feedback, starRating = null) {
      const text = feedback.toLowerCase().trim();
      
      // Skip analysis if feedback is too short or generic
      if (text.length < 3) {
        return {
          sentiment: 'neutral',
          confidence: 0.3,
          flags: ['insufficient_content']
        };
      }
      
      // Enhanced positive keywords
      const positiveWords = [
        'great', 'excellent', 'amazing', 'fantastic', 'wonderful', 'perfect', 'love', 'best', 'awesome', 'outstanding', 'brilliant', 'superb', 'incredible', 'fabulous', 'terrific', 'satisfied', 'happy', 'pleased', 'good', 'nice', 'recommend', 'helpful', 'useful', 'smooth', 'easy', 'fast', 'efficient', 'reliable', 'quality', 'professional', 'friendly'
      ];
      
      // Enhanced negative keywords
      const negativeWords = [
        'terrible', 'awful', 'horrible', 'bad', 'worst', 'hate', 'disgusting', 'useless', 'disappointing', 'poor', 'pathetic', 'rubbish', 'garbage', 'broken', 'failed', 'waste', 'regret', 'frustrated', 'annoying', 'slow', 'confusing', 'difficult', 'complicated', 'expensive', 'overpriced', 'buggy', 'crashes', 'unreliable'
      ];
      
      // Spam indicators
      const spamWords = [
        'click here', 'buy now', 'free money', 'guaranteed', 'no risk', 'limited time', 'act now', 'urgent', '100% free', 'make money fast', 'earn $', 'work from home', 'get rich quick', 'special offer', 'limited offer'
      ];
      
      // Inappropriate content
      const inappropriateWords = [
        'damn', 'hell', 'stupid', 'idiot', 'moron', 'dumb', 'crap', 'sucks', 'bullshit', 'fuck', 'shit'
      ];
      
      // Generic/meaningless phrases that shouldn't be analyzed
      const genericPhrases = [
        'no feedback', 'no comment', 'test', 'testing', 'good', 'ok', 'okay', 'fine', 'nice'
      ];
      
      // Check if feedback is too generic
      if (genericPhrases.some(phrase => text === phrase)) {
        return {
          sentiment: 'neutral',
          confidence: 0.4,
          flags: ['generic_feedback']
        };
      }
      
      let positiveScore = 0;
      let negativeScore = 0;
      let spamScore = 0;
      let inappropriateScore = 0;
      
      // Count word occurrences with context awareness
      const words = text.split(/\s+/);
      
      words.forEach(word => {
        if (positiveWords.includes(word)) positiveScore++;
        if (negativeWords.includes(word)) negativeScore++;
        if (inappropriateWords.includes(word)) inappropriateScore++;
      });
      
      // Check for spam phrases
      spamWords.forEach(phrase => {
        if (text.includes(phrase)) spamScore++;
      });
      
      // Determine sentiment with star rating correlation
      let sentiment = 'neutral';
      let confidence = 0.6;
      let flags = [];
      
      // Check for spam first
      if (spamScore > 0) {
        sentiment = 'spam';
        confidence = 0.8;
        flags.push('potential_spam');
      } 
      // Check for inappropriate content
      else if (inappropriateScore > 0) {
        sentiment = 'inappropriate';
        confidence = 0.7;
        flags.push('inappropriate_language');
      } 
      // Use star rating as primary indicator with text analysis as secondary
      else if (starRating) {
        if (starRating >= 5) {
          sentiment = 'positive';
          confidence = positiveScore > 0 ? 0.9 : 0.75;
          if (negativeScore > positiveScore) {
            flags.push('rating_text_mismatch');
            confidence = 0.6;
          }
        } else if (starRating >= 4) {
          sentiment = positiveScore >= negativeScore ? 'positive' : 'neutral';
          confidence = 0.8;
          if (negativeScore > positiveScore + 1) {
            flags.push('rating_text_mismatch');
          }
        } else if (starRating <= 3) {
          sentiment = negativeScore > positiveScore ? 'negative' : 'neutral';
          confidence = 0.8;
          if (starRating <= 2) {
            sentiment = 'negative';
            confidence = 0.85;
          }
          if (positiveScore > negativeScore + 1) {
            flags.push('rating_text_mismatch');
          }
        }
      } 
      // Fallback to text analysis only
      else {
        if (positiveScore > negativeScore && positiveScore > 0) {
          sentiment = 'positive';
          confidence = Math.min(0.9, 0.6 + (positiveScore * 0.1));
        } else if (negativeScore > positiveScore && negativeScore > 0) {
          sentiment = 'negative';
          confidence = Math.min(0.9, 0.6 + (negativeScore * 0.1));
        }
      }
      
      // Adjust confidence based on text length and quality
      if (words.length < 3) {
        confidence = Math.max(0.3, confidence - 0.2);
        flags.push('short_feedback');
      } else if (words.length > 10) {
        confidence = Math.min(0.95, confidence + 0.1);
      }
      
      return {
        sentiment,
        confidence,
        flags
      };
    }
    
    // Enhanced callOpenAI with fallback
    async function callOpenAIWithFallback(feedback, starRating = null) {
      try {
        // Try OpenAI first
        return await callOpenAI(feedback);
      } catch (error) {
        console.warn('OpenAI API failed, using rule-based analysis:', error.message);
        showMessage('‚ö†Ô∏è Using backup analysis system (OpenAI unavailable)', 'success');
        
        // Fallback to rule-based analysis with star rating
        return analyzeWithRules(feedback, starRating);
      }
    }
    
    // Helper function to get membership badge class
    function getMembershipBadgeClass(membershipType) {
      switch(membershipType) {
        case 'business': return 'user-type-business';
        case 'premium': return 'user-type-premium';
        case 'basic': return 'user-type-basic';
        case 'freemium': return 'user-type-basic';
        case 'free': return 'user-type-basic';
        case 'normal': return 'user-type-basic'; // Exception handling for legacy "normal" userType
        default: 
          console.warn(`Unknown membership type: ${membershipType}, defaulting to basic class`);
          return 'user-type-basic';
      }
    }
    
    // Helper function to get membership display name
    function getMembershipDisplayName(membershipType) {
      switch(membershipType) {
        case 'business': return 'Business';
        case 'premium': return 'Premium';
        case 'basic': return 'Basic';
        case 'freemium': return 'Basic';
        case 'free': return 'Basic';
        case 'normal': return 'Basic'; // Exception handling for legacy "normal" userType
        default: 
          console.warn(`Unknown membership type: ${membershipType}, defaulting to Basic`);
          return 'Basic';
      }
    }
    
    // Helper function to format dates
    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      
      try {
        // Handle Firestore timestamp or string
        let date;
        if (timestamp.toDate) {
          date = timestamp.toDate();
        } else if (typeof timestamp === 'string') {
          date = new Date(timestamp);
        } else {
          date = new Date(timestamp);
        }
        
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      } catch (error) {
        return 'Invalid date';
      }
    }
    
  </script>
</body>
</html>
