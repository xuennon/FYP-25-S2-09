<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Services - Wise Fitness Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f9f9f9;
      color: #222;
    }
    h1 { margin-bottom: 16px; }
    form {
      margin-bottom: 30px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    input[type="file"] {
      margin-top: 8px;
    }
    button {
      margin-top: 12px;
      padding: 10px 18px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
      font-weight: 700;
    }
    tr:hover {
      background: #f1f1f1;
    }
    .actions button {
      background: #28a745;
      margin-right: 8px;
    }
    .actions button.delete {
      background: #dc3545;
    }
    img.preview {
      max-width: 100px;
      max-height: 100px;
      display: block;
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <h1>Manage Services</h1>

  <form id="serviceForm">
    <input type="hidden" id="serviceId" />

    <label for="serviceName">Service Name</label>
    <input type="text" id="serviceName" required />

    <label for="servicePrice">Price ($)</label>
    <input type="number" id="servicePrice" required min="0" step="0.01" />

    <label for="serviceDesc">Description</label>
    <textarea id="serviceDesc" rows="3" required></textarea>

    <label for="serviceImage">Image (optional)</label>
    <input type="file" id="serviceImage" accept="image/*" />
    <img id="previewImage" class="preview" style="display:none;" />

    <button type="submit">Create Service</button>
    <button type="button" id="cancelUpdateBtn" style="display:none; margin-left: 10px; background:#6c757d;">Cancel Update</button>
  </form>

  <table id="servicesTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Description</th>
        <th>Image</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Service rows inserted here -->
    </tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIFV7ynXUzA0p-CrmVOE2lFRgaf_9g_k4",
      authDomain: "fyp-25-s2-09.firebaseapp.com",
      projectId: "fyp-25-s2-09",
      storageBucket: "fyp-25-s2-09.appspot.com",
      messagingSenderId: "838641447649",
      appId: "1:838641447649:web:6ddfb234b3d445f16dbda0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const servicesCollection = collection(db, "services");

    const serviceForm = document.getElementById("serviceForm");
    const serviceIdInput = document.getElementById("serviceId");
    const nameInput = document.getElementById("serviceName");
    const priceInput = document.getElementById("servicePrice");
    const descInput = document.getElementById("serviceDesc");
    const imageInput = document.getElementById("serviceImage");
    const previewImage = document.getElementById("previewImage");
    const cancelUpdateBtn = document.getElementById("cancelUpdateBtn");
    const servicesTableBody = document.querySelector("#servicesTable tbody");

    let servicesData = [];
    let isUpdating = false;

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) {
        previewImage.src = URL.createObjectURL(file);
        previewImage.style.display = "block";
      } else {
        previewImage.style.display = "none";
      }
    });

    async function uploadImage(file) {
      const storageRef = ref(storage, "services/" + Date.now() + "_" + file.name);
      const snapshot = await uploadBytes(storageRef, file);
      return getDownloadURL(snapshot.ref);
    }

    async function loadServices() {
      servicesTableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
      const querySnapshot = await getDocs(servicesCollection);
      servicesData = [];
      querySnapshot.forEach(doc => {
        servicesData.push({ id: doc.id, ...doc.data() });
      });
      renderServicesTable();
    }

    function renderServicesTable() {
      if (servicesData.length === 0) {
        servicesTableBody.innerHTML = "<tr><td colspan='5'>No services found.</td></tr>";
        return;
      }

      servicesTableBody.innerHTML = "";
      servicesData.forEach(service => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${service.name}</td>
          <td>$${parseFloat(service.price || 0).toFixed(2)}</td>
          <td>${service.description}</td>
          <td>${service.imageURL ? `<img src="${service.imageURL}" width="60" />` : '-'}</td>
          <td class="actions">
            <button onclick="startUpdate('${service.id}')">Update</button>
            <button class="delete" onclick="deleteService('${service.id}')">Delete</button>
          </td>
        `;
        servicesTableBody.appendChild(tr);
      });
    }

    serviceForm.addEventListener("submit", async e => {
      e.preventDefault();

      const name = nameInput.value.trim();
      const price = priceInput.value.trim();
      const description = descInput.value.trim();
      const imageFile = imageInput.files[0];

      if (!name || !price || !description) {
        alert("Please fill in all required fields.");
        return;
      }

      let imageURL = "";

      if (imageFile) {
        imageURL = await uploadImage(imageFile);
      }

      if (isUpdating) {
        const id = serviceIdInput.value;
        const docRef = doc(db, "services", id);
        const updateData = { name, price, description };
        if (imageURL) updateData.imageURL = imageURL;

        await updateDoc(docRef, updateData);
        alert("Service updated successfully.");
      } else {
        await addDoc(servicesCollection, { name, price, description, imageURL });
        alert("Service created successfully.");
      }

      serviceForm.reset();
      previewImage.style.display = "none";
      isUpdating = false;
      serviceForm.querySelector("button[type=submit]").textContent = "Create Service";
      cancelUpdateBtn.style.display = "none";

      loadServices();
    });

    window.startUpdate = function(id) {
      const service = servicesData.find(s => s.id === id);
      if (!service) return alert("Service not found.");

      serviceIdInput.value = id;
      nameInput.value = service.name;
      priceInput.value = service.price;
      descInput.value = service.description;
      previewImage.src = service.imageURL || "";
      previewImage.style.display = service.imageURL ? "block" : "none";

      isUpdating = true;
      serviceForm.querySelector("button[type=submit]").textContent = "Update Service";
      cancelUpdateBtn.style.display = "inline-block";
    };

    cancelUpdateBtn.addEventListener("click", () => {
      isUpdating = false;
      serviceIdInput.value = "";
      serviceForm.reset();
      previewImage.style.display = "none";
      serviceForm.querySelector("button[type=submit]").textContent = "Create Service";
      cancelUpdateBtn.style.display = "none";
    });

    window.deleteService = async function(id) {
      if (!confirm("Are you sure you want to delete this service?")) return;
      await deleteDoc(doc(db, "services", id));
      alert("Service deleted.");
      loadServices();
    };

    loadServices();
  </script>

</body>
</html>
